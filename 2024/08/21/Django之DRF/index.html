<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="keywords" content="Hexo Theme Redefine">
    
    <meta name="author" content="rainbowYao">
    <!-- preconnect -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    
    <!--- Seo Part-->
    
    <link rel="canonical" href="https://yyybbbyyyb.github.io/2024/08/21/django之drf/"/>
    <meta name="robots" content="index,follow">
    <meta name="googlebot" content="index,follow">
    <meta name="revisit-after" content="1 days">
    
        <meta name="description" content="DRF（Django REST framework） 给Django提供了用于构建Web API 的强大而灵活的工具包，包括序列化器、认证、权限、分页、过滤和限流 本文学习自：大江狗   前置知识DRF安装官方文档：https:&#x2F;&#x2F;www.django-rest-framework.org&#x2F;  pip安装：pip install djangorestframework 图形化操作：注册到项目的I">
<meta property="og:type" content="article">
<meta property="og:title" content="Django之DRF">
<meta property="og:url" content="https://yyybbbyyyb.github.io/2024/08/21/Django%E4%B9%8BDRF/index.html">
<meta property="og:site_name" content="rainbowYao&#39;s Blog">
<meta property="og:description" content="DRF（Django REST framework） 给Django提供了用于构建Web API 的强大而灵活的工具包，包括序列化器、认证、权限、分页、过滤和限流 本文学习自：大江狗   前置知识DRF安装官方文档：https:&#x2F;&#x2F;www.django-rest-framework.org&#x2F;  pip安装：pip install djangorestframework 图形化操作：注册到项目的I">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://typora-yyb.oss-cn-beijing.aliyuncs.com/img/%E6%88%AA%E5%B1%8F2024-08-18%2021.20.55.png">
<meta property="article:published_time" content="2024-08-21T15:56:36.000Z">
<meta property="article:modified_time" content="2024-09-18T01:21:54.805Z">
<meta property="article:author" content="rainbowYao">
<meta property="article:tag" content="Django">
<meta property="article:tag" content="DRF">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://typora-yyb.oss-cn-beijing.aliyuncs.com/img/%E6%88%AA%E5%B1%8F2024-08-18%2021.20.55.png">
    
    
        <!-- Google tag (gtag.js) -->
        <script src="https://www.googletagmanager.com/gtag/js?id="></script>
        <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', '');
        </script>
    
    <!--- Icon Part-->
    <link rel="icon" type="image/png" href="/images/rainbow.ico" sizes="192x192">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/rainbow.ico">
    <meta name="theme-color" content="#A31F34">
    <link rel="shortcut icon" href="/images/rainbow.ico">
    <!--- Page Info-->
    
    <title>
        
            Django之DRF -
        
        rainbowYao&#39;s Blog
    </title>

    
<link rel="stylesheet" href="/fonts/Chillax/chillax.css">


    <!--- Inject Part-->
    

    
<link rel="stylesheet" href="/css/style.css">


    
        
<link rel="stylesheet" href="/assets/build/styles.css">

    

    
<link rel="stylesheet" href="/fonts/GeistMono/geist-mono.css">

    
<link rel="stylesheet" href="/fonts/Geist/geist.css">

    <!--- Font Part-->
    
    
    
    

    
        
<script src="/js/libs/anime.min.js"></script>

    

    <script id="hexo-configurations">
    window.config = {"hostname":"yyybbbyyyb.github.io","root":"/","language":"zh-CN"};
    window.theme = {"articles":{"style":{"font_size":"16px","line_height":1.5,"image_border_radius":"14px","image_alignment":"center","image_caption":false,"link_icon":true,"title_alignment":"left","headings_top_spacing":{"h1":"3.2rem","h2":"2.4rem","h3":"1.9rem","h4":"1.6rem","h5":"1.4rem","h6":"1.3rem"}},"word_count":{"enable":true,"count":true,"min2read":true},"author_label":{"enable":true,"auto":false,"list":[]},"code_block":{"copy":true,"style":"mac","font":{"enable":false,"family":null,"url":null}},"toc":{"enable":true,"max_depth":3,"number":false,"expand":true,"init_open":true},"copyright":{"enable":true,"default":"cc_by_nc_sa"},"lazyload":true,"recommendation":{"enable":true,"title":"推荐阅读","limit":3,"mobile_limit":2,"placeholder":"/images/wallhaven-wqery6-light.webp","skip_dirs":[]}},"colors":{"primary":"#A31F34","secondary":null,"default_mode":"light"},"global":{"fonts":{"chinese":{"enable":false,"family":null,"url":null},"english":{"enable":false,"family":null,"url":null}},"content_max_width":"1000px","sidebar_width":"210px","hover":{"shadow":true,"scale":true},"scroll_progress":{"bar":true,"percentage":true},"website_counter":{"url":"https://cn.vercount.one/js","enable":true,"site_pv":true,"site_uv":true,"post_pv":true},"single_page":true,"preloader":true,"open_graph":true,"google_analytics":{"enable":true,"id":null}},"home_banner":{"enable":true,"style":"fixed","image":{"light":"/images/flower.jpg","dark":"/images/flower.jpg"},"title":"This is rainbowYao's Blog","subtitle":{"text":["已老实, 求放过...","我真服了..."],"hitokoto":{"enable":false,"api":"https://v1.hitokoto.cn"},"typing_speed":100,"backing_speed":80,"starting_delay":500,"backing_delay":1500,"loop":true,"smart_backspace":true},"text_color":{"light":"#000000","dark":"#000000"},"text_style":{"title_size":"2.8rem","subtitle_size":"1.5rem","line_height":1.2},"custom_font":{"enable":false,"family":null,"url":null},"social_links":{"enable":true,"style":"center","links":{"github":"https://github.com/yyybbbyyyb/","instagram":"https://www.instagram.com/yyb913665114/","zhihu":null,"twitter":null,"email":"22373393@buaa.edu.cn"},"qrs":{"weixin":"/images/wechat.jpg"}}},"plugins":{"feed":{"enable":false},"aplayer":{"enable":false,"type":"fixed","audios":[{"name":null,"artist":null,"url":null,"cover":null,"lrc":null}]},"mermaid":{"enable":false,"version":"9.3.0"}},"version":"2.6.4","navbar":{"auto_hide":false,"color":{"left":"#f78736","right":"#367df7","transparency":35},"width":{"home":"1200px","pages":"1000px"},"links":{"Home":{"path":"/","icon":"fa-regular fa-house"},"Categories":{"path":"/categories/","icon":"fa-regular fa-folder"},"Tags":{"path":"/tags/","icon":"fa-regular fa-tags"},"Archives":{"path":"/archives","icon":"fa-regular fa-archive"}},"search":{"enable":false,"preload":true}},"page_templates":{"friends_column":2,"tags_style":"blur"},"home":{"sidebar":{"enable":true,"position":"left","first_item":"menu","announcement":"目前文章较少","show_on_mobile":true,"links":{"Archives":{"path":"/archives","icon":"fa-regular fa-archive"},"Tags":{"path":"/tags","icon":"fa-regular fa-tags"},"Categories":{"path":"/categories","icon":"fa-regular fa-folder"}}},"article_date_format":"auto","categories":{"enable":true,"limit":3},"tags":{"enable":true,"limit":3}},"footerStart":"2024/1/1 00:00:00"};
    window.lang_ago = {"second":"%s 秒前","minute":"%s 分钟前","hour":"%s 小时前","day":"%s 天前","week":"%s 周前","month":"%s 个月前","year":"%s 年前"};
    window.data = {"masonry":false};
  </script>
    
    <!--- Fontawesome Part-->
    
<link rel="stylesheet" href="/fontawesome/fontawesome.min.css">

    
<link rel="stylesheet" href="/fontawesome/brands.min.css">

    
<link rel="stylesheet" href="/fontawesome/solid.min.css">

    
<link rel="stylesheet" href="/fontawesome/regular.min.css">

    
    
    
    
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
<div class="progress-bar-container">
    
        <span class="scroll-progress-bar"></span>
    

    
        <span class="pjax-progress-bar"></span>
<!--        <span class="swup-progress-icon">-->
<!--            <i class="fa-solid fa-circle-notch fa-spin"></i>-->
<!--        </span>-->
    
</div>



    <style>
    :root {
        --preloader-background-color: #fff;
        --preloader-text-color: #000;
    }

    @media (prefers-color-scheme: dark) {
        :root {
            --preloader-background-color: #202124;
            --preloader-text-color: #fff;
        }
    }

    @media (prefers-color-scheme: light) {
        :root {
            --preloader-background-color: #fff;
            --preloader-text-color: #000;
        }
    }

    @media (max-width: 600px) {
        .ml13 {
            font-size: 2.6rem !important; /* Adjust this value as needed */
        }
    }

    .preloader {
        display: flex;
        flex-direction: column;
        gap: 1rem; /* Tailwind 'gap-4' is 1rem */
        align-items: center;
        justify-content: center;
        position: fixed;
        padding: 12px;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        width: 100vw;
        height: 100vh; /* 'h-screen' is 100% of the viewport height */
        background-color: var(--preloader-background-color);
        z-index: 1100; /* 'z-[1100]' sets the z-index */
        transition: opacity 0.2s ease-in-out;
    }

    .ml13 {
        font-size: 3.2rem;
        /* text-transform: uppercase; */
        color: var(--preloader-text-color);
        letter-spacing: -1px;
        font-weight: 500;
        font-family: 'Chillax-Variable', sans-serif;
        text-align: center;
    }

    .ml13 .word {
        display: inline-flex;
        flex-wrap: wrap;
        white-space: nowrap;
    }

    .ml13 .letter {
        display: inline-block;
        line-height: 1em;
    }
</style>

<div class="preloader">
    <h2 class="ml13">
        rainbowYao&#39;s Blog
    </h2>
    <script>
        var textWrapper = document.querySelector('.ml13');
        // Split text into words
        var words = textWrapper.textContent.trim().split(' ');

        // Clear the existing content
        textWrapper.innerHTML = '';

        // Wrap each word and its letters in spans
        words.forEach(function(word) {
            var wordSpan = document.createElement('span');
            wordSpan.classList.add('word');
            wordSpan.innerHTML = word.replace(/\S/g, "<span class='letter'>$&</span>");
            textWrapper.appendChild(wordSpan);
            textWrapper.appendChild(document.createTextNode(' ')); // Add space between words
        });

        var animation = anime.timeline({loop: true})
            .add({
                targets: '.ml13 .letter',
                translateY: [40,0],
                translateZ: 0,
                opacity: [0,1],
                filter: ['blur(5px)', 'blur(0px)'], // Starting from blurred to unblurred
                easing: "easeOutExpo",
                duration: 1400,
                delay: (el, i) => 300 + 30 * i,
            }).add({
                targets: '.ml13 .letter',
                translateY: [0,-40],
                opacity: [1,0],
                filter: ['blur(0px)', 'blur(5px)'], // Ending from unblurred to blurred
                easing: "easeInExpo",
                duration: 1200,
                delay: (el, i) => 100 + 30 * i,
                complete: function() {
                    hidePreloader(); // Call hidePreloader after the animation completes
                }
            });

        let themeStatus = JSON.parse(localStorage.getItem('REDEFINE-THEME-STATUS'))?.isDark;

        // If the theme status is not found in local storage, check the preferred color scheme
        if (themeStatus === undefined || themeStatus === null) {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                themeStatus = 'dark';
            } else {
                themeStatus = 'light';
            }
        }

        // Now you can use the themeStatus variable in your code
        if (themeStatus) {
            document.documentElement.style.setProperty('--preloader-background-color', '#202124');
            document.documentElement.style.setProperty('--preloader-text-color', '#fff');
        } else {
            document.documentElement.style.setProperty('--preloader-background-color', '#fff');
            document.documentElement.style.setProperty('--preloader-text-color', '#000');
        }

        window.addEventListener('load', function () {
            setTimeout(hidePreloader, 5000); // Call hidePreloader after 5000 milliseconds if not already called by animation
        });

        function hidePreloader() {
            var preloader = document.querySelector('.preloader');
            preloader.style.opacity = '0';
            setTimeout(function () {
                preloader.style.display = 'none';
            }, 200);
        }
    </script>
</div>

<main class="page-container" id="swup">

    

    <div class="main-content-container">


        <div class="main-content-header">
            <header class="navbar-container px-6 md:px-12">

    <div class="navbar-content ">
        <div class="left">
            
                <a class="logo-image" href="/">
                    <img src="/images/rainbow.ico">
                </a>
            
            <a class="logo-title" href="/">
                
                rainbowYao&#39;s Blog
                
            </a>
        </div>

        <div class="right">
            <!-- PC -->
            <div class="desktop">
                <ul class="navbar-list">
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/"
                                        >
                                    <i class="fa-regular fa-house fa-fw"></i>
                                    首页
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/categories/"
                                        >
                                    <i class="fa-regular fa-folder fa-fw"></i>
                                    分类
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/tags/"
                                        >
                                    <i class="fa-regular fa-tags fa-fw"></i>
                                    标签
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/archives"
                                        >
                                    <i class="fa-regular fa-archive fa-fw"></i>
                                    归档
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                    
                </ul>
            </div>
            <!-- Mobile -->
            <div class="mobile">
                
                <div class="icon-item navbar-bar">
                    <div class="navbar-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile sheet -->
    <div class="navbar-drawer h-screen w-full absolute top-0 left-0 bg-background-color flex flex-col justify-between">
        <ul class="drawer-navbar-list flex flex-col px-4 justify-center items-start">
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/"
                        >
                            <span>
                                首页
                            </span>
                            
                                <i class="fa-regular fa-house fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/categories/"
                        >
                            <span>
                                分类
                            </span>
                            
                                <i class="fa-regular fa-folder fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/tags/"
                        >
                            <span>
                                标签
                            </span>
                            
                                <i class="fa-regular fa-tags fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/archives"
                        >
                            <span>
                                归档
                            </span>
                            
                                <i class="fa-regular fa-archive fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            

            
            
                
                    
                    
                    
            
        </ul>

        <div class="statistics flex justify-around my-2.5">
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/tags">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">8</div>
        <div class="label text-third-text-color text-sm">标签</div>
    </a>
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/categories">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">5</div>
        <div class="label text-third-text-color text-sm">分类</div>
    </a>
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/archives">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">14</div>
        <div class="label text-third-text-color text-sm">文章</div>
    </a>
</div>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="main-content-body">

            

            <div class="main-content">

                
                    <div class="post-page-container flex relative justify-between box-border w-full h-full">
    <div class="article-content-container">

        <div class="article-title relative w-full">
            
                
                
                <img src="https://blog-yyb.oss-cn-beijing.aliyuncs.com/thumbnail/thumbnail15.jpg" alt="Django之DRF" class="w-full h-60 sm:h-72 md:h-80 object-cover sm:rounded-t-large dark:brightness-75"/>
                
                <div class="w-full flex items-center absolute bottom-0 justify-start">
                    <h1 class="article-title-cover text-center mx-6 my-6 text-second-text-color bg-background-color-transparent px-4 py-3 text-3xl sm:text-4xl md:text-5xl font-semibold backdrop-blur-lg rounded-xl border border-border-color ">Django之DRF</h1>
                </div>
            
            </div>

        
            <div class="article-header flex flex-row gap-2 items-center px-2 sm:px-6 md:px-8">
                <div class="avatar w-[46px] h-[46px] flex-shrink-0 rounded-medium border border-border-color p-[1px]">
                    <img src="/images/touxiang.jpg">
                </div>
                <div class="info flex flex-col justify-between">
                    <div class="author flex items-center">
                        <span class="name text-default-text-color text-lg font-semibold">rainbowYao</span>
                        
                            <span class="author-label ml-1.5 text-xs px-2 py-0.5 rounded-small text-third-text-color border border-shadow-color-1">Lv2</span>
                        
                    </div>
                    <div class="meta-info">
                        <div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fa-regular fa-pen-fancy"></i>&nbsp;
        <span class="desktop">2024-08-21 23:56:36</span>
        <span class="mobile">2024-08-21 23:56:36</span>
        <span class="hover-info">创建</span>
    </span>
    
        <span class="article-date article-meta-item">
            <i class="fa-regular fa-wrench"></i>&nbsp;
            <span class="desktop">2024-09-18 09:21:54</span>
            <span class="mobile">2024-09-18 09:21:54</span>
            <span class="hover-info">更新</span>
        </span>
    

    
        <span class="article-categories article-meta-item">
            <i class="fa-regular fa-folders"></i>&nbsp;
            <ul>
                
                
                    
                        
                        <li>
                            <a href="/categories/%E5%90%8E%E7%AB%AF%E7%AC%94%E8%AE%B0/">后端笔记</a>&nbsp;
                        </li>
                    
                    
                
            </ul>
        </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fa-regular fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/Django/">Django</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/DRF/">DRF</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
    
    
        <span class="article-pv article-meta-item">
            <i class="fa-regular fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

                    </div>
                </div>
            </div>
        

        


        <div class="article-content markdown-body px-2 sm:px-6 md:px-8 pb-8">
            <blockquote>
<p>DRF（Django REST framework） 给Django提供了用于构建Web API 的强大而灵活的工具包，包括序列化器、认证、权限、分页、过滤和限流</p>
<p>本文学习自：<a class="link"   target="_blank" rel="noopener" href="https://pythondjango.cn/django/rest-framework" >大江狗 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
</blockquote>
<h2 id="前置知识"><a href="#前置知识" class="headerlink" title="前置知识"></a>前置知识</h2><h3 id="DRF安装"><a href="#DRF安装" class="headerlink" title="DRF安装"></a>DRF安装</h3><p>官方文档：<a class="link"   target="_blank" rel="noopener" href="https://www.django-rest-framework.org/" >https://www.django-rest-framework.org/ <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p>pip安装：<code>pip install djangorestframework</code></p>
<p>图形化操作：注册到项目的<code>INSTALL_APPS</code>中</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">INSTALLED_APPS = [</span><br><span class="line">    <span class="string">&#x27;django.contrib.admin&#x27;</span>,</span><br><span class="line">    ···</span><br><span class="line">    <span class="string">&#x27;django.contrib.staticfiles&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;rest_framework&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;your_app&#x27;</span>, <span class="comment"># 你自己的app</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure></div>

<br>



<h3 id="序列化基础知识"><a href="#序列化基础知识" class="headerlink" title="序列化基础知识"></a>序列化基础知识</h3><p>每种编程语言都有各自的数据类型, 将属于自己语言的数据类型或对象转换为可通过网络传输或可以存储到本地磁盘的数据格式（如：XML、JSON或特定格式的字节串）的过程称为序列化(seralization)；反之则称为反序列化。</p>
<h4 id="Python数据序列化"><a href="#Python数据序列化" class="headerlink" title="Python数据序列化"></a>Python数据序列化</h4><p>Python自带json模块的dumps方法可以将python常用数据格式（比如列表或字典)转化为json格式</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line">res = json.dumps(&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;John&quot;</span>, <span class="string">&quot;score&quot;</span>: <span class="number">112</span>&#125;)</span><br><span class="line"><span class="comment"># res: &#x27;&#123;&quot;name&quot;: &quot;John&quot;, &quot;score&quot;: 112&#125;&#x27;</span></span><br></pre></td></tr></table></figure></div>



<h4 id="Django查询集序列化"><a href="#Django查询集序列化" class="headerlink" title="Django查询集序列化"></a>Django查询集序列化</h4><p>Django专属的数据类型比如查询集<code>QuerySet</code>和<code>ValueQuerySet</code>类型数据，提供了自带的serializers类</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Django Queryset to Json</span></span><br><span class="line"><span class="keyword">from</span> django.core <span class="keyword">import</span> serializers</span><br><span class="line"></span><br><span class="line">data = serializers.serialize(<span class="string">&quot;json&quot;</span>, SomeModel.objects.<span class="built_in">all</span>())</span><br><span class="line">data1 = serializers.serialize(<span class="string">&quot;json&quot;</span>, SomeModel.objects.<span class="built_in">all</span>(), fields=(<span class="string">&#x27;name&#x27;</span>,<span class="string">&#x27;id&#x27;</span>))</span><br><span class="line">data2 = serializers.serialize(<span class="string">&quot;json&quot;</span>, SomeModel.objects.<span class="built_in">filter</span>(field = some_value))</span><br></pre></td></tr></table></figure></div>

<p>当使用values查询部分字段以提升些性能时，返回来的结果需要先转换成列表格式，再用<code> json.dumps()</code>方法序列化成json格式</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> django.core.serializers.json <span class="keyword">import</span> DjangoJSONEncoder</span><br><span class="line"></span><br><span class="line">queryset = myModel.objects.<span class="built_in">filter</span>(foo_icontains=bar).values(<span class="string">&#x27;f1&#x27;</span>, <span class="string">&#x27;f2&#x27;</span>, <span class="string">&#x27;f3&#x27;</span>)</span><br><span class="line">data4 = json.dumps(<span class="built_in">list</span>(queryset), cls=DjangoJSONEncoder)</span><br></pre></td></tr></table></figure></div>

<blockquote>
<p>与Django自带的serializers类相比，DRF的序列化器更强大，可以根据模型生成序列化器，还能对客户端发送过来的数据进行验证</p>
</blockquote>
<br>


<h3 id="符合RESTful规范的API"><a href="#符合RESTful规范的API" class="headerlink" title="符合RESTful规范的API"></a>符合RESTful规范的API</h3><p>REST是REpresentational State Transfer三个单词的缩写，由Roy Fielding于2000年论文中提出。简单来说，就是用URI表示资源，用HTTP方法(GET, POST, PUT, DELETE)表征对这些资源进行增删查改的操作。</p>
<h4 id="协议、域名、版本"><a href="#协议、域名、版本" class="headerlink" title="协议、域名、版本"></a>协议、域名、版本</h4><p>尽量使用https协议，使用专属域名来提供API服务。API版本可以放在URL里面，也可以用HTTP的header进行内容协商</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https://api.example.com/v1</span><br><span class="line">https://www.example.com/api/v1</span><br></pre></td></tr></table></figure></div>



<h4 id="URI-统一资源标识符"><a href="#URI-统一资源标识符" class="headerlink" title="URI(统一资源标识符)"></a>URI(统一资源标识符)</h4><p>在RESTful架构中，每个网址代表一种资源，这个网络地址就是URI（URL是URI的一种）。因为URI对应一种资源，所以里面不能有动词，只能有名词。一般来说，数据库中的表都是同种记录的集合，所以API中的名词也应该使用复数形式。</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">https://api.example.com/v1/users 				# 用户列表资源地址</span><br><span class="line">https://api.example.com/v1/users/&#123;id&#125; 			# 用户id=5对应资源。注意：这里是users/5，而不是user/5</span><br><span class="line">https://api.example.com/v1/users/&#123;id&#125;/articles  # 用户id=5发表的文章列表</span><br></pre></td></tr></table></figure></div>

<p>一个 URI就应该是一个资源，本身不能包含任何动作 </p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># 传统的Django开发可能将URL写成如下</span><br><span class="line">https://api.example.com/v1/users/&#123;id&#125;/edit/ 		# 编辑用户</span><br><span class="line">https://api.example.com/v1/users/&#123;id&#125;/delete/ 		# 删除用户</span><br><span class="line"></span><br><span class="line"># 符合REST规范则要求资源的URI地址是固定不变的，对同一资源应使用不同的HTTP请求方法进行不同的操作</span><br><span class="line"># 比如常见的增删改查</span><br><span class="line">[POST]    https://api.example.com/v1/users   		# 新增</span><br><span class="line">[GET]     https://api.example.com/v1/users/1 		# 查询</span><br><span class="line">[PATCH]   https://api.example.com/v1/users/1 		# 更新</span><br><span class="line">[PUT]     https://api.example.com/v1/users/1 		# 覆盖，全部更新</span><br><span class="line">[DELETE]  https://api.example.com/v1/users/1 		# 删除</span><br></pre></td></tr></table></figure></div>

<p>有时候URL比较长，可能由多个单词组成，建议使用中划线”-“分割，而不是下划线”_“作为分隔符；另外每个URL的结尾不能加斜线”&#x2F;”。</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">https://api.example.com/v1/user-management/users/&#123;id&#125; 		# ✅</span><br><span class="line">https://api.example.com/v1/user_management/users/&#123;id&#125; 		# ❌</span><br><span class="line">https://api.example.com/v1/user-management/users/&#123;id&#125;/ 		# ❌</span><br></pre></td></tr></table></figure></div>



<h4 id="HTTP请求方法"><a href="#HTTP请求方法" class="headerlink" title="HTTP请求方法"></a>HTTP请求方法</h4><p>常用的五个HTTP请求方法（括号里是对应的SQL命令)</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">GET（SELECT）：从服务器取出资源（一项或多项）。</span><br><span class="line">POST（CREATE）：在服务器新建一个资源。</span><br><span class="line">PUT（UPDATE）：在服务器更新资源（客户端提供改变后的完整资源）。</span><br><span class="line">PATCH（UPDATE）：在服务器更新资源（客户端提供改变的属性）。</span><br><span class="line">DELETE（DELETE）：从服务器删除资源。</span><br></pre></td></tr></table></figure></div>

<p>还有两个不常用方法<code>HEAD</code>和<code>OPTIONS</code>。<code>HEAD</code>和<code>GET</code>本质是一样的，区别在于<code>HEAD</code>不含有呈现数据，而仅仅是HTTP头信息；<code>OPTIONS</code>极少使用，它主要用于获取当前URL所支持的方法。</p>
<h4 id="过滤（filtering）"><a href="#过滤（filtering）" class="headerlink" title="过滤（filtering）"></a>过滤（filtering）</h4><p>如果记录数量很多，服务器不可能都将它们返回给用户。符合RESTful规范的API应该支持过滤。下面是一些常见的通过参数过滤的方式。</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">?limit=10：指定返回记录的数量</span><br><span class="line">?offset=10：指定返回记录的开始位置。</span><br><span class="line">?page=2&amp;per_page=100：指定第几页，以及每页的记录数。</span><br><span class="line">?sortby=name&amp;order=asc：指定返回结果按照哪个姓名排序，以及排序顺序。</span><br><span class="line">?user_type_id=1：指定筛选条件，比如用户类型</span><br></pre></td></tr></table></figure></div>

<p>DRF与django-filter联用可以轻松实现过滤。</p>
<h4 id="状态码（Status-Codes）"><a href="#状态码（Status-Codes）" class="headerlink" title="状态码（Status Codes）"></a>状态码（Status Codes）</h4><p>服务器在处理客户端请求后还应向用户返回响应的状态码和提示信息，常见的有以下一些状态码。</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">200 OK - [GET]：服务器成功返回用户请求的数据，该操作是幂等的（Idempotent）</span><br><span class="line">201 CREATED - [POST/PUT/PATCH]：用户新建或修改数据成功</span><br><span class="line">202 Accepted - [*]：表示一个请求已经进入后台排队（异步任务）</span><br><span class="line">204 NO CONTENT - [DELETE]：用户删除数据成功</span><br><span class="line">400 INVALID REQUEST - [POST/PUT/PATCH]：用户发出的请求有错误，服务器没有进行新建或修改数据的操作，该操作是幂等的。</span><br><span class="line">401 Unauthorized - [*]：表示用户没有权限（令牌、用户名、密码错误）。</span><br><span class="line">403 Forbidden - [*] 表示用户得到授权（与401错误相对），但是访问是被禁止的。</span><br><span class="line">404 NOT FOUND - [*]：用户发出的请求针对的是不存在的记录，服务器没有进行操作，该操作是幂等的。</span><br><span class="line">406 Not Acceptable - [GET]：用户请求的格式不可得（比如用户请求JSON格式，但是只有XML格式）。</span><br><span class="line">410 Gone -[GET]：用户请求的资源被永久删除，且不会再得到的。</span><br><span class="line">422 Unprocesable entity - [POST/PUT/PATCH] 当创建一个对象时，发生一个验证错误。</span><br><span class="line">500 INTERNAL SERVER ERROR - [*]：服务器发生错误</span><br></pre></td></tr></table></figure></div>



<h4 id="Hypermedia-API"><a href="#Hypermedia-API" class="headerlink" title="Hypermedia API"></a>Hypermedia API</h4><p>RESTful API最好做到Hypermedia，即返回结果中提供链接，连向其他API方法，使得用户不查文档，也知道下一步应该做什么。比如，当用户向api.example.com的根目录发出请求，会得到这样一个文档。</p>
<div class="highlight-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;link&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;rel&quot;</span><span class="punctuation">:</span>   <span class="string">&quot;collection https://www.example.com/zoos&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;href&quot;</span><span class="punctuation">:</span>  <span class="string">&quot;https://api.example.com/zoos&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;List of zoos&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span>  <span class="string">&quot;application/vnd.yourformat+json&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<br>


<hr>
<br>


<h2 id="示例引入序列化器与函数视图（FBV）"><a href="#示例引入序列化器与函数视图（FBV）" class="headerlink" title="示例引入序列化器与函数视图（FBV）"></a>示例引入序列化器与函数视图（FBV）</h2><p>这部分将以博客为例，使用DRF提供的序列化器开发两个API接口并测试，下面是简要的api描述</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 接口描述：文章列表资源。GET请求获取文章列表资源, POST请求提交新文章</span><br><span class="line"># 接口地址: http://127.0.0.1:8000/api/v1/articles</span><br><span class="line"># 请求方式：GET, POST</span><br><span class="line"># 返回参数：JSON格式文章列表和状态码</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 接口描述：单篇文章资源。GET获取文章详情, PUT修改，DELETE删除</span><br><span class="line"># 接口地址: http://127.0.0.1:8000/api/v1/articles/&#123;id&#125;</span><br><span class="line"># 请求方式：GET, PUT, DELETE</span><br><span class="line"># 返回参数: GET和PUT(JSON格式文章详情和状态码), DELETE(状态码)</span><br></pre></td></tr></table></figure></div>

<br>



<h3 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h3><h4 id="搭建项目"><a href="#搭建项目" class="headerlink" title="搭建项目"></a>搭建项目</h4><div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建虚拟环境</span></span><br><span class="line">python3 -m venv venv</span><br><span class="line"><span class="built_in">source</span> venv/bin/activate </span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装环境</span></span><br><span class="line">pip install django</span><br><span class="line">pip install djangorestframwork </span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建项目与应用</span></span><br><span class="line">django-admin startproject apiproject </span><br><span class="line"><span class="built_in">cd</span> apiproject </span><br><span class="line">python manage.py startapp blog </span><br></pre></td></tr></table></figure></div>

<p>下面是在settings.py中注册app</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">INSTALLED_APPS =(</span><br><span class="line">    ...</span><br><span class="line">    <span class="string">&#x27;rest_framework&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;blog&#x27;</span>,                <span class="comment"># 若希望避免与第三方库的app名冲突，可使用blog.apps.BlogConfig</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure></div>



<h4 id="创建模型"><a href="#创建模型" class="headerlink" title="创建模型"></a>创建模型</h4><p>在blog&#x2F;models.py中创建文章模型与用户模型</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"><span class="keyword">from</span> django.utils.translation <span class="keyword">import</span> gettext_lazy <span class="keyword">as</span> _</span><br><span class="line"><span class="keyword">from</span> django.contrib.auth <span class="keyword">import</span> get_user_model</span><br><span class="line"></span><br><span class="line">User = get_user_model()</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Article</span>(models.Model):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Article Model&quot;&quot;&quot;</span></span><br><span class="line">    STATUS_CHOICES = (</span><br><span class="line">        (<span class="string">&#x27;p&#x27;</span>, _(<span class="string">&#x27;Published&#x27;</span>)),</span><br><span class="line">        (<span class="string">&#x27;d&#x27;</span>, _(<span class="string">&#x27;Draft&#x27;</span>)),</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    title = models.CharField(verbose_name=_(<span class="string">&#x27;Title&#x27;</span>), max_length=<span class="number">90</span>, db_index=<span class="literal">True</span>)</span><br><span class="line">    body = models.TextField(verbose_name=_(<span class="string">&#x27;Body&#x27;</span>), blank=<span class="literal">True</span>)</span><br><span class="line">    author = models.ForeignKey(User, verbose_name=_(<span class="string">&#x27;Author&#x27;</span>), on_delete=models.CASCADE, related_name=<span class="string">&#x27;articles&#x27;</span>)</span><br><span class="line">    status = models.CharField(_(<span class="string">&#x27;Status&#x27;</span>), max_length=<span class="number">1</span>, choices=STATUS_CHOICES, default=<span class="string">&#x27;d&#x27;</span>, null=<span class="literal">True</span>, blank=<span class="literal">True</span>)</span><br><span class="line">    create_date = models.DateTimeField(verbose_name=_(<span class="string">&#x27;Create Date&#x27;</span>), auto_now_add=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__str__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.title</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Meta</span>:</span><br><span class="line">        ordering = [<span class="string">&#x27;-create_date&#x27;</span>]</span><br><span class="line">        verbose_name = <span class="string">&quot;Article&quot;</span></span><br><span class="line">        verbose_name_plural = <span class="string">&quot;Articles&quot;</span></span><br></pre></td></tr></table></figure></div>

<p>其中gettext_lazy是用于字符串延迟翻译，get_user_model是Django自带的用户模型</p>
<p>之后执行如下命令同步数据库并创建超级用户</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">python manage.py makemigrations</span><br><span class="line">python manage.py migrate</span><br><span class="line">python manage.py createsuperuser</span><br></pre></td></tr></table></figure></div>

<p>接下来我们就可以使用Django自带的后台添加文章与用户，方便后续api测试</p>
<h4 id="配置Django后台"><a href="#配置Django后台" class="headerlink" title="配置Django后台"></a>配置Django后台</h4><p>编辑<code>blog/admin.py</code>文件</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.contrib <span class="keyword">import</span> admin</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Article</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Register your models here.</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ArticleAdmin</span>(admin.ModelAdmin):</span><br><span class="line">    list_display = (<span class="string">&#x27;title&#x27;</span>, <span class="string">&#x27;author&#x27;</span>, <span class="string">&#x27;status&#x27;</span>, <span class="string">&#x27;create_date&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;filter options&#x27;&#x27;&#x27;</span></span><br><span class="line">    list_filter = (<span class="string">&#x27;status&#x27;</span>,)    <span class="comment"># 过滤</span></span><br><span class="line">    </span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;10 items per page&#x27;&#x27;&#x27;</span></span><br><span class="line">    list_per_page = <span class="number">10</span>           <span class="comment"># 分页</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">admin.site.register(Article, ArticleAdmin)</span><br></pre></td></tr></table></figure></div>

<p>运行<code>python manage.py runserver</code>，即可通过admin路由进入Django自带的后台管理平台</p>
<br>




<h3 id="自定义序列化器"><a href="#自定义序列化器" class="headerlink" title="自定义序列化器"></a>自定义序列化器</h3><p>序列化器可将复杂的数据类型（如 Django 模型实例）转换为可传输的格式（如 JSON），也可以将接收到的数据反向转换为模型实例，同时自动进行数据验证和处理</p>
<p>DRF提供了<code>Serializer</code>类和<code>ModelSerializer</code>类两种方式供你自定义序列化器。前者需手动指定需要序列化和反序列化的字段，后者根据模型(model)生成需要序列化和反序列化的字段，可以使代码更简洁</p>
<h4 id="使用Serializer类"><a href="#使用Serializer类" class="headerlink" title="使用Serializer类"></a>使用Serializer类</h4><p>在blog目录下创建一个名为serializers.py的文件，并添加</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> serializers</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Article</span><br><span class="line"><span class="keyword">from</span> django.contrib.auth <span class="keyword">import</span> get_user_model</span><br><span class="line"></span><br><span class="line">User = get_user_model()</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ArticleSerializer</span>(serializers.Serializer):</span><br><span class="line">    <span class="built_in">id</span> = serializers.IntegerField(read_only=<span class="literal">True</span>)</span><br><span class="line">    title = serializers.CharField(required=<span class="literal">True</span>, allow_blank=<span class="literal">True</span>, max_length=<span class="number">90</span>)</span><br><span class="line">    body = serializers.CharField(required=<span class="literal">False</span>, allow_blank=<span class="literal">True</span>)</span><br><span class="line">    author = serializers.ReadOnlyField(source=<span class="string">&quot;author.id&quot;</span>)</span><br><span class="line">    status = serializers.ChoiceField(choices=Article.STATUS_CHOICES, default=<span class="string">&#x27;d&#x27;</span>)</span><br><span class="line">    create_date = serializers.DateTimeField(read_only=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">create</span>(<span class="params">self, validated_data</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Create a new &quot;article&quot; instance</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> Article.objects.create(**validated_data)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">update</span>(<span class="params">self, instance, validated_data</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Use validated data to return an existing `Article`instance。</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        instance.title = validated_data.get(<span class="string">&#x27;title&#x27;</span>, instance.title)</span><br><span class="line">        instance.body = validated_data.get(<span class="string">&#x27;body&#x27;</span>, instance.body)</span><br><span class="line">        instance.status = validated_data.get(<span class="string">&#x27;status&#x27;</span>, instance.status)</span><br><span class="line">        instance.save()</span><br><span class="line">        <span class="keyword">return</span> instance</span><br></pre></td></tr></table></figure></div>

<p>序列化器类的第一部分定义了序列化&#x2F;反序列化的字段。<code>create()</code>和<code>update()</code>方法定义了在调用<code>serializer.save()</code>时如何创建和修改完整的实例</p>
<p>序列化器类与Django <code>Form</code>类非常相似，并在各种字段中设置各种验证，例如<code>required</code>，<code>max_length</code>和<code>default</code></p>
<p>定义序列化器时一定要注明哪些是仅可读字段(<code>read-only fields</code>)，哪些是普通字段。对于<code>read-only fields</code>，客户端是不需要也不能够通过POST或PUT请求提交相关数据进行反序列化的</p>
<p>本例中和create_date都是由模型自动生成，每个article的author我们也希望在视图中与request.user绑定，而不是由用户通过POST或PUT自行修改，所以这些字段都是read-only。相反title，body和status是用户可以添加或修改的字段，所以未设成read-only</p>
<h4 id="使用ModelSerializer类"><a href="#使用ModelSerializer类" class="headerlink" title="使用ModelSerializer类"></a>使用ModelSerializer类</h4><p><code>ArticleSerializer</code>类中重复了很多包含在<code>Article</code>模型（model）中的字段信息。使用<code>ModelSerializer</code>类可以重构序列化器类，使整体代码更简洁</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ArticleSerializer</span>(serializers.ModelSerializer):</span><br><span class="line">    author = serializers.HiddenField(default=serializers.CurrentUserDefault())</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Meta</span>:</span><br><span class="line">        model = Article</span><br><span class="line">        fields = <span class="string">&#x27;__all__&#x27;</span></span><br><span class="line">        read_only_fields = (<span class="string">&#x27;id&#x27;</span>, <span class="string">&#x27;author&#x27;</span>, <span class="string">&#x27;create_date&#x27;</span>)</span><br></pre></td></tr></table></figure></div>

<br>




<h3 id="编写API视图"><a href="#编写API视图" class="headerlink" title="编写API视图"></a>编写API视图</h3><p>接下来我们将编写两个基于函数的视图：<code>article_list</code>和<code>article_detail</code>，后续会介绍基于类的视图</p>
<p>编辑<code>blog/views.py</code>文件，添加以下内容</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> status</span><br><span class="line"><span class="keyword">from</span> rest_framework.decorators <span class="keyword">import</span> api_view</span><br><span class="line"><span class="keyword">from</span> rest_framework.response <span class="keyword">import</span> Response</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Article</span><br><span class="line"><span class="keyword">from</span> .serializers <span class="keyword">import</span> ArticleSerializer</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@api_view(<span class="params">[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">article_list</span>(<span class="params">request, <span class="built_in">format</span>=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    List all articles, or create a new article.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;GET&#x27;</span>:</span><br><span class="line">        articles = Article.objects.<span class="built_in">all</span>()</span><br><span class="line">        serializer = ArticleSerializer(articles, many=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">return</span> Response(serializer.data)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">elif</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">        serializer = ArticleSerializer(data=request.data, context=&#123;<span class="string">&#x27;request&#x27;</span>: request&#125;)</span><br><span class="line">        <span class="keyword">if</span> serializer.is_valid():</span><br><span class="line">            serializer.save()</span><br><span class="line">            <span class="keyword">return</span> Response(serializer.data, status=status.HTTP_201_CREATED)</span><br><span class="line">        <span class="keyword">return</span> Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="meta">@api_view(<span class="params">[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;PUT&#x27;</span>, <span class="string">&#x27;DELETE&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">article_detail</span>(<span class="params">request, pk, <span class="built_in">format</span>=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Retrieve，update or delete an article instance。</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        article = Article.objects.get(pk=pk)</span><br><span class="line">    <span class="keyword">except</span> Article.DoesNotExist:</span><br><span class="line">        <span class="keyword">return</span> Response(status=status.HTTP_404_NOT_FOUND)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;GET&#x27;</span>:</span><br><span class="line">        serializer = ArticleSerializer(article)</span><br><span class="line">        <span class="keyword">return</span> Response(serializer.data)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">elif</span> request.method == <span class="string">&#x27;PUT&#x27;</span>:</span><br><span class="line">        serializer = ArticleSerializer(article, data=request.data, context=&#123;<span class="string">&#x27;request&#x27;</span>: request&#125;)</span><br><span class="line">        <span class="keyword">if</span> serializer.is_valid():</span><br><span class="line">            serializer.save()</span><br><span class="line">            <span class="keyword">return</span> Response(serializer.data)</span><br><span class="line">        <span class="keyword">return</span> Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">elif</span> request.method == <span class="string">&#x27;DELETE&#x27;</span>:</span><br><span class="line">        article.delete()</span><br><span class="line">        <span class="keyword">return</span> Response(status=status.HTTP_204_NO_CONTENT)</span><br></pre></td></tr></table></figure></div>

<p>这两个函数视图看似和Django普通函数视图非常类似，但其作用大不相同。这里我们使用了DRF提供的<code>@api_view</code>这个非常重要的装饰器，实现了以下几大功能：</p>
<ul>
<li>与Django传统函数视图相区分，强调这是API视图，并限定了可以接受的请求方法</li>
<li>拓展了Django原来的request对象。新的request对象不仅仅支持request.POST提交的数据，还支持其它请求方式如PUT或PATCH等方式提交的数据，所有的数据都在<code>request.data</code>字典里。这对开发Web API非常有用</li>
</ul>
<p>我们不再显式地将请求或响应绑定到特定的内容类型比如HttpResponse和JSONResponse，我们统一使用Response方法返回响应，该方法支持内容协商，可根据客户端请求的内容类型返回不同的响应数据。</p>
<p>20行与42行的<code>context=&#123;&#39;request&#39;: request&#125;</code>的作用是解决序列化器中<code>CurrentUserDefault</code> 的依赖</p>
<br>



<h3 id="给URLs添加可选的格式后缀"><a href="#给URLs添加可选的格式后缀" class="headerlink" title="给URLs添加可选的格式后缀"></a>给URLs添加可选的格式后缀</h3><p>为了充分利用我们的响应不再与单一内容类型连接，我们可以为API路径添加对格式后缀(.json或.api)的支持</p>
<p>我们之前的视图函数定义时已经加入<code> format=None</code>，接下来更改<code>blog/urls.py</code>文件，给现有的<code>urlpatterns</code>加上<code>format_suffix_patterns</code></p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> re_path</span><br><span class="line"><span class="keyword">from</span> rest_framework.urlpatterns <span class="keyword">import</span> format_suffix_patterns</span><br><span class="line"><span class="keyword">from</span> . <span class="keyword">import</span> views</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    re_path(<span class="string">r&#x27;^articles/$&#x27;</span>, views.article_list),</span><br><span class="line">    re_path(<span class="string">r&#x27;^articles/(?P&lt;pk&gt;[0-9]+)$&#x27;</span>, views.article_detail),</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">urlpatterns = format_suffix_patterns(urlpatterns)</span><br></pre></td></tr></table></figure></div>

<p>最后把app的urls加入到项目URL配置<code>apiproject/urls.py</code>文件中</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.contrib <span class="keyword">import</span> admin</span><br><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path, include</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    path(<span class="string">&#x27;admin/&#x27;</span>, admin.site.urls),</span><br><span class="line">    path(<span class="string">&#x27;v1/&#x27;</span>, include(<span class="string">&#x27;blog.urls&#x27;</span>)),</span><br><span class="line">]</span><br></pre></td></tr></table></figure></div>


<br>



<h3 id="API测试"><a href="#API测试" class="headerlink" title="API测试"></a>API测试</h3><p>测试工具有很多，curl命令、postman、apifox（推荐），这里使用DRF自带的图形化测试界面</p>
<p>直接使用浏览器访问<a class="link"   target="_blank" rel="noopener" href="http://127.0.0.1:8000/v1/articles%EF%BC%8C%E5%8D%B3%E5%8F%AF%E7%9C%8B%E5%88%B0%E5%9B%BE%E5%BD%A2%E5%8C%96%E6%B5%8B%E8%AF%95%E7%95%8C%E9%9D%A2%EF%BC%8C%E5%8F%AF%E8%87%AA%E8%A1%8C%E9%80%9A%E8%BF%87%E5%9B%BE%E5%BD%A2%E5%8C%96%E4%BA%A4%E4%BA%92%E5%81%9A%E6%B5%8B%E8%AF%95" >http://127.0.0.1:8000/v1/articles，即可看到图形化测试界面，可自行通过图形化交互做测试 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://typora-yyb.oss-cn-beijing.aliyuncs.com/img/%E6%88%AA%E5%B1%8F2024-08-18%2021.20.55.png"
                     
                ></p>
<br>


<hr>
<br>


<h2 id="基于类的视图和视图集"><a href="#基于类的视图和视图集" class="headerlink" title="基于类的视图和视图集"></a>基于类的视图和视图集</h2><p>一个中大型的Web项目代码量通常是非常大的，如果全部使用函数视图写，那么代码的复用率是非常低的。而使用类视图呢，就可以有效的提高代码复用，因为类是可以被继承的，可以拓展的</p>
<p>DRF推荐使用基于类的视图(CBV)来开发API, 并提供了4种开发CBV开发模式：</p>
<ul>
<li>使用基础的<code>APIView</code>类</li>
<li>使用Mixins类和<code>GenericAPI</code>类混配</li>
<li>使用通用视图<code>generics.*</code>类, 比如<code>generics.ListCreateAPIView</code></li>
<li>使用视图集<code>ViewSet</code>和<code>ModelViewSet</code></li>
</ul>
<br>


<h3 id="使用基础APIView类"><a href="#使用基础APIView类" class="headerlink" title="使用基础APIView类"></a>使用基础APIView类</h3><p>DRF的APIView类继承了Django自带的View类, 一样可以按请求方法调用不同的处理函数，比如get方法处理GET请求，post方法处理POST请求</p>
<p>不过DRF的APIView要强大得多。它不仅支持更多请求方法，而且对Django的request对象进行了封装，可以使用request.data获取用户通过POST, PUT和PATCH方法发过来的数据，而且支持插拔式地配置认证、权限和限流类（后面会介绍）</p>
<p>我们可以更新之前blog&#x2F;views.py中的代码</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.views <span class="keyword">import</span> APIView</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Article</span><br><span class="line"><span class="keyword">from</span> .serializers <span class="keyword">import</span> ArticleSerializer</span><br><span class="line"><span class="keyword">from</span> rest_framework.response <span class="keyword">import</span> Response</span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> status</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ArticleList</span>(<span class="title class_ inherited__">APIView</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    List all articles, or create a new article.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get</span>(<span class="params">self, request, <span class="built_in">format</span>=<span class="literal">None</span></span>):</span><br><span class="line">        articles = Article.objects.<span class="built_in">all</span>()</span><br><span class="line">        serializer = ArticleSerializer(articles, many=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">return</span> Response(serializer.data)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">post</span>(<span class="params">self, request, <span class="built_in">format</span>=<span class="literal">None</span></span>):</span><br><span class="line">        serializer = ArticleSerializer(data=request.data, context=&#123;<span class="string">&#x27;request&#x27;</span>: request&#125;)</span><br><span class="line">        <span class="keyword">if</span> serializer.is_valid():</span><br><span class="line">            serializer.save()</span><br><span class="line">            <span class="keyword">return</span> Response(serializer.data, status=status.HTTP_201_CREATED)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ArticleDetail</span>(<span class="title class_ inherited__">APIView</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Retrieve, update or delete an article instance.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_object</span>(<span class="params">self, pk</span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">return</span> Article.objects.get(pk=pk)</span><br><span class="line">        <span class="keyword">except</span> Article.DoesNotExist:</span><br><span class="line">            <span class="keyword">return</span> Response(status=status.HTTP_404_NOT_FOUND)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get</span>(<span class="params">self, request, pk, <span class="built_in">format</span>=<span class="literal">None</span></span>):</span><br><span class="line">        article = <span class="variable language_">self</span>.get_object(pk)</span><br><span class="line">        serializer = ArticleSerializer(article)</span><br><span class="line">        <span class="keyword">return</span> Response(serializer.data)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">put</span>(<span class="params">self, request, pk, <span class="built_in">format</span>=<span class="literal">None</span></span>):</span><br><span class="line">        article = <span class="variable language_">self</span>.get_object(pk)</span><br><span class="line">        serializer = ArticleSerializer(instance=article, data=request.data)</span><br><span class="line">        <span class="keyword">if</span> serializer.is_valid():</span><br><span class="line">            serializer.save()</span><br><span class="line">            <span class="keyword">return</span> Response(serializer.data)</span><br><span class="line">        <span class="keyword">return</span> Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">self, request, pk, <span class="built_in">format</span>=<span class="literal">None</span></span>):</span><br><span class="line">        article = <span class="variable language_">self</span>.get_object(pk)</span><br><span class="line">        article.delete()</span><br><span class="line">        <span class="keyword">return</span> Response(status=status.HTTP_204_NO_CONTENT)</span><br></pre></td></tr></table></figure></div>

<p>类视图需要调用<code>as_view()</code>的方法才能在视图中实现查找指定方法，接下来修改blog&#x2F;urls.py中的代码</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> re_path</span><br><span class="line"><span class="keyword">from</span> rest_framework.urlpatterns <span class="keyword">import</span> format_suffix_patterns</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> . <span class="keyword">import</span> views</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    re_path(<span class="string">r&#x27;^articles/$&#x27;</span>, views.ArticleList.as_view()),</span><br><span class="line">    re_path(<span class="string">r&#x27;^articles/(?P&lt;pk&gt;[0-9]+)$&#x27;</span>, views.ArticleDetail.as_view()),</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">urlpatterns = format_suffix_patterns(urlpatterns)</span><br></pre></td></tr></table></figure></div>

<p>这中方法与之前基于函数的视图差别并不大，最大不同的是不需要在对用户的请求方法进行判断，该视图可以自动将不同请求转发到相应处理方法，逻辑上也更清晰</p>
<br>



<h3 id="用Mixin类和GenericAPI类混配"><a href="#用Mixin类和GenericAPI类混配" class="headerlink" title="用Mixin类和GenericAPI类混配"></a>用Mixin类和GenericAPI类混配</h3><p>使用基础的APIView类并没有大量简化代码，比如需要对文章类别Category模型也进行序列化和反序列化，我们只需要复制Article视图代码，将Article模型改成Category模型, 序列化类由<code>ArticleSeralizer</code>类改成<code>CategorySerializer</code>类就行了</p>
<p>对于这些通用的增删改查行为，DRF已经提供了相应的Mixin类。Mixin类可与<code>generics.GenericAPI</code>类联用，灵活组合成你所需要的视图</p>
<p>下面我们更改视图函数为：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> mixins</span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> generics</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Article</span><br><span class="line"><span class="keyword">from</span> .serializers <span class="keyword">import</span> ArticleSerializer</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ArticleList</span>(mixins.ListModelMixin,</span><br><span class="line">                  mixins.CreateModelMixin,</span><br><span class="line">                  generics.GenericAPIView):</span><br><span class="line">    queryset = Article.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class = ArticleSerializer</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get</span>(<span class="params">self, request, *args, **kwargs</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.<span class="built_in">list</span>(request, *args, **kwargs)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">post</span>(<span class="params">self, request, *args, **kwargs</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.create(request, *args, **kwargs)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 将request.user与author绑定。调用create方法时执行如下函数。</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">perform_create</span>(<span class="params">self, serializer</span>):</span><br><span class="line">        serializer.save(author=<span class="variable language_">self</span>.request.user)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ArticleDetail</span>(mixins.RetrieveModelMixin,</span><br><span class="line">                    mixins.UpdateModelMixin,</span><br><span class="line">                    mixins.DestroyModelMixin,</span><br><span class="line">                    generics.GenericAPIView):</span><br><span class="line">    queryset = Article.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class = ArticleSerializer</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get</span>(<span class="params">self, request, *args, **kwargs</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.retrieve(request, *args, **kwargs)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">put</span>(<span class="params">self, request, *args, **kwargs</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.update(request, *args, **kwargs)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">self, request, *args, **kwargs</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.destroy(request, *args, **kwargs)</span><br></pre></td></tr></table></figure></div>

<p><strong>GenericAPIView 类继承了APIView类，提供了基础的API视图。它对用户请求进行了转发，并对Django自带的request对象进行了封装。不过它比APIView类更强大，因为它还可以通过<code>queryset</code>和<code>serializer_class</code>属性指定需要序列化与反序列化的模型或queryset及所用到的序列化器类</strong></p>
<p>这里的 <code>ListModelMixin</code> 和 <code>CreateModelMixin</code>类则分别引入了<code>.list() </code>和<code>.create()</code>方法，当用户发送get请求时调用Mixin提供的list()方法，将指定queryset序列化后输出，发送post请求时调用Mixin提供的create()方法，创建新的实例对象</p>
<p>DRF还提供<code>RetrieveModelMixin</code>, <code>UpdateModelMixin</code>和<code>DestroyModelMixin</code>类，实现了对单个对象实例的查、改和删操作</p>
<p><code>perform_create</code>这个钩子函数是<code>CreateModelMixin</code>类自带的，用于执行创建对象时需要执行的其它方法，比如发送邮件等功能，有点类似于Django的信号。类似的钩子函数还有UpdateModelMixin提供的<code>perform_update</code>方法和DestroyModelMixin提供的<code>perform_destroy</code>方法</p>
<br>



<h3 id="使用通用视图Generics-类"><a href="#使用通用视图Generics-类" class="headerlink" title="使用通用视图Generics.*类"></a>使用通用视图Generics.*类</h3><p>将Mixin类和GenericAPI类混配，已经减少了一些代码，但还可以做得更好，比如将get请求与mixin提供的list方法进行绑定感觉有些多余。幸好DRF还提供了一套常用的将 Mixin 类与 GenericAPI类已经组合好了的视图，开箱即用，可以进一步简化我们的代码</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Article</span><br><span class="line"><span class="keyword">from</span> .serializers <span class="keyword">import</span> ArticleSerializer</span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> generics</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ArticleList</span>(generics.ListCreateAPIView):</span><br><span class="line">    queryset = Article.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class = ArticleSerializer</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 将request.user与author绑定</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">perform_create</span>(<span class="params">self, serializer</span>):</span><br><span class="line">        serializer.save(author=<span class="variable language_">self</span>.request.user)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ArticleDetail</span>(generics.RetrieveUpdateDestroyAPIView):</span><br><span class="line">    queryset = Article.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class =ArticleSerializer</span><br></pre></td></tr></table></figure></div>

<p>顾名思义，<code>generics.ListCreateAPIView</code>类支持List、Create两种视图功能，分别对应GET和POST请求。<code>generics.RetrieveUpdateDestroyAPIView</code>支持Retrieve、Update、Destroy操作，其对应方法分别是GET、PUT和DELETE</p>
<p>其它常用generics类视图还包括<code>ListAPIView</code>, <code>RetrieveAPIView</code>, <code>RetrieveUpdateAPIView</code>等等。你可以根据实际需求使用，为你的API写视图时只需要定义<code>queryset</code>和<code>serializer_class</code>即可</p>
<br>



<h3 id="使用视图集ViewSet"><a href="#使用视图集ViewSet" class="headerlink" title="使用视图集ViewSet"></a>使用视图集ViewSet</h3><p>使用通用视图generics类后视图代码已经大大简化，但是<code>ArticleList</code>和<code>ArticleDetail</code>两个类中<code>queryset</code>和<code>serializer_class</code>属性依然存在代码重复。使用视图集可以将两个类视图进一步合并，一次性提供List、Create、Retrieve、Update、Destroy这5种常见操作，这样<code>queryset</code>和<code>seralizer_class</code>属性也只需定义一次就好, 这就变成了视图集(viewset)</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Article</span><br><span class="line"><span class="keyword">from</span> .serializers <span class="keyword">import</span> ArticleSerializer</span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> viewsets</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ArticleViewSet</span>(viewsets.ModelViewSet):</span><br><span class="line">    <span class="comment"># 用一个视图集替代ArticleList和ArticleDetail两个视图</span></span><br><span class="line">    queryset = Article.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class = ArticleSerializer</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 自行添加，将request.user与author绑定</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">perform_create</span>(<span class="params">self, serializer</span>):</span><br><span class="line">        serializer.save(author=<span class="variable language_">self</span>.request.user)</span><br></pre></td></tr></table></figure></div>

<p>使用视图集后，我们需要使用DRF提供的路由router来分发urls，因为一个视图集现在对应多个urls，而不像之前的一个url对应一个视图函数或一个视图类</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> re_path</span><br><span class="line"><span class="keyword">from</span> rest_framework.urlpatterns <span class="keyword">import</span> format_suffix_patterns</span><br><span class="line"><span class="keyword">from</span> . <span class="keyword">import</span> views</span><br><span class="line"><span class="keyword">from</span> rest_framework.routers <span class="keyword">import</span> DefaultRouter</span><br><span class="line"></span><br><span class="line">router = DefaultRouter()</span><br><span class="line">router.register(<span class="string">r&#x27;articles&#x27;</span>, viewset=views.ArticleViewSet)</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line"></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">urlpatterns += router.urls</span><br></pre></td></tr></table></figure></div>

<p>一个视图集对应List、Create、Retrieve、Update、Destroy这5种操作。有时候我只需要其中的一种或几种操作，可在<code>urls.py</code>中指定方法映射即可</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> re_path</span><br><span class="line"><span class="keyword">from</span> rest_framework.urlpatterns <span class="keyword">import</span> format_suffix_patterns</span><br><span class="line"><span class="keyword">from</span> . <span class="keyword">import</span> views</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">article_list = views.ArticleViewSet.as_view(</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&#x27;get&#x27;</span>: <span class="string">&#x27;list&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;post&#x27;</span>: <span class="string">&#x27;create&#x27;</span></span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">article_detail = views.ArticleViewSet.as_view(&#123;</span><br><span class="line">    <span class="string">&#x27;get&#x27;</span>: <span class="string">&#x27;retrieve&#x27;</span>,  <span class="comment"># 只处理get请求，获取单个记录</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    re_path(<span class="string">r&#x27;^articles/$&#x27;</span>, article_list),</span><br><span class="line">    re_path(<span class="string">r&#x27;^articles/(?P&lt;pk&gt;[0-9]+)$&#x27;</span>, article_detail),</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">urlpatterns = format_suffix_patterns(urlpatterns)</span><br></pre></td></tr></table></figure></div>

<p>另外DRF还提供了<code>ReadOnlyModelViewSet</code>这个类，它仅支持list和retrive这两个可读的操作</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> viewsets</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserViewSet</span>(viewsets.ReadOnlyModelViewSet):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    ReadOnlyModelViewSet仅提供list和detail可读动作</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    queryset = Article.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class = ArticleSerializer</span><br></pre></td></tr></table></figure></div>

<p>Django视图集viewset代码最少，但这是以牺牲了代码的可读性为代价的，因为它对代码进行了高度地抽象化。另外urls由router生成，不如自己手动配置的清楚</p>
<br>



<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ol>
<li><p>使用基础的 <code>APIView</code> 类</p>
<ul>
<li><p>优点：灵活性最高，可以完全控制请求和响应的处理逻辑；适合处理复杂的、需要自定义处理逻辑的 API 端点。</p>
</li>
<li><p>缺点：需要手动编写大量样板代码，如处理请求方法、验证和序列化。</p>
</li>
<li><p>适合复杂的场景，但不推荐在常规的 CRUD 操作中使用，因为会导致代码冗余。</p>
</li>
</ul>
</li>
<li><p>使用 <code>Mixins</code> 类和 <code>GenericAPIView</code> 类混配</p>
<ul>
<li><p>优点：提供了比 <code>APIView</code> 更高的代码复用性；保留了一定的灵活性，允许在需要的地方进行自定义。</p>
</li>
<li><p>缺点：尽管比 <code>APIView</code> 更简洁，但仍然需要手动组合不同的 mixin，代码相对较多；对于新手来说，理解 mixin 的组合和使用可能有些复杂。</p>
</li>
<li><p>适合需要部分自定义逻辑的场景，但更推荐选择通用generics类</p>
</li>
</ul>
</li>
<li><p>使用通用视图 <code>generics.*</code> 类</p>
<ul>
<li><p>优点：提供了高度集成的常见视图（如 <code>ListCreateAPIView</code>），可以快速创建标准的 CRUD API；极大地减少了样板代码，使代码更加简洁易读。</p>
</li>
<li><p>缺点：灵活性稍有下降，如果需要高度自定义逻辑，可能需要覆盖默认方法或引入额外的逻辑。</p>
</li>
<li><p>在大多数常见的 API 开发场景中，这是<strong>最推荐的方式</strong>，因为它在简洁性和功能性之间找到了很好的平衡。</p>
</li>
</ul>
</li>
<li><p>使用视图集 <code>ViewSet</code> 和 <code>ModelViewSet</code></p>
<ul>
<li><p>优点：提供了最高程度的代码复用和简洁性，尤其是 <code>ModelViewSet</code>，可以自动处理所有 CRUD 操作；与 DRF 的路由系统紧密集成，能自动生成标准的路由，非常适合快速开发 RESTful API。</p>
</li>
<li><p>缺点：灵活性最低，如果需要特殊的逻辑处理，可能需要重写或覆盖许多方法。</p>
</li>
<li><p>在标准化的 CRUD 操作中，这是最推荐的方式，可以快速开发 API。但在需要高度定制的场景下，可能需要退回到使用 <code>generics</code> 或 <code>mixin</code>。</p>
</li>
</ul>
</li>
</ol>
<hr>
<h2 id="序列化器进阶"><a href="#序列化器进阶" class="headerlink" title="序列化器进阶"></a>序列化器进阶</h2><p>这一节关注如何修改序列化器，控制序列化后响应数据的输出格式；如何在反序列化时对客户端提供过来的数据进行验证(validation)以及如何动态加载或重写序列化器类自带的方法</p>
<br>


<h3 id="改变序列化器的输出"><a href="#改变序列化器的输出" class="headerlink" title="改变序列化器的输出"></a>改变序列化器的输出</h3><h4 id="指定source来源"><a href="#指定source来源" class="headerlink" title="指定source来源"></a>指定source来源</h4><p>打开<code>blog/serializers.py</code>，新建两个可读字段<code>author、status</code>字段，用以覆盖原来Article模型默认的字段，其中指定author字段的来源为单个author对象的username，status字段为<code>get_status_display</code>方法返回的完整状态</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ArticleSerializer</span>(serializers.ModelSerializer):</span><br><span class="line">    author = serializers.ReadOnlyField(source=<span class="string">&quot;author.username&quot;</span>)</span><br><span class="line">    status = serializers.ReadOnlyField(source=<span class="string">&quot;get_status_display&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Meta</span>:</span><br><span class="line">        model = Article</span><br><span class="line">        fields = <span class="string">&#x27;__all__&#x27;</span></span><br><span class="line">        read_only_fields = (<span class="string">&#x27;id&#x27;</span>, <span class="string">&#x27;author&#x27;</span>, <span class="string">&#x27;create_date&#x27;</span>)</span><br></pre></td></tr></table></figure></div>

<p>这个看似完美，但里面其实有个问题。我们定义了一个仅可读的status字段把原来的status字段覆盖了，这样反序列化时用户将不能再对文章发表状态进行修改（原来的status字段是可读可修改的）</p>
<p>一个更好的方式在<code>ArticleSerializer</code>新增一个为<code>full_status</code>的可读字段，而不是简单覆盖原本可读可写的字段</p>
<h4 id="使用SerializerMethodField方法"><a href="#使用SerializerMethodField方法" class="headerlink" title="使用SerializerMethodField方法"></a>使用SerializerMethodField方法</h4><p>status都是以Published或Draft英文字符串表示的，如果想在输出的json格式数据中新增<code>cn_status</code>字段，但cn_status本身并不是Article模型中存在的字段，这时可以使用<code>SerializerMethodField</code>，它可用于将任何类型的数据添加到对象的序列化表示中, 非常有用</p>
<p>编辑<code>blog/serializers.py</code></p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ArticleSerializer</span>(serializers.ModelSerializer):</span><br><span class="line">    author = serializers.ReadOnlyField(source=<span class="string">&quot;author.username&quot;</span>)</span><br><span class="line">    status = serializers.ReadOnlyField(source=<span class="string">&quot;get_status_display&quot;</span>)</span><br><span class="line">    cn_status = serializers.SerializerMethodField()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Meta</span>:</span><br><span class="line">        model = Article</span><br><span class="line">        fields = <span class="string">&#x27;__all__&#x27;</span></span><br><span class="line">        read_only_fields = (<span class="string">&#x27;id&#x27;</span>, <span class="string">&#x27;author&#x27;</span>, <span class="string">&#x27;create_date&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_cn_status</span>(<span class="params">self, obj</span>):</span><br><span class="line">        <span class="keyword">if</span> obj.status == <span class="string">&#x27;p&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;已发表&quot;</span></span><br><span class="line">        <span class="keyword">elif</span> obj.status == <span class="string">&#x27;d&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;草稿&quot;</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span></span><br></pre></td></tr></table></figure></div>

<p>需要注意的是<code>SerializerMethodField</code>通常用于显示模型中原本不存在的字段，类似可读字段，你不能通过反序列化对其直接进行修改</p>
<h4 id="使用-to-representation方法"><a href="#使用-to-representation方法" class="headerlink" title="使用 to_representation方法"></a>使用 to_representation方法</h4><p><code>to_representation()</code> 允许我们改变序列化的输出内容, 给其添加额外的数据</p>
<p>假设我们更改文章模型与序列化器：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Article</span>(models.Model):</span><br><span class="line">    title = models.CharField(max_length=<span class="number">256</span>)</span><br><span class="line">    body = models.TextField()</span><br><span class="line">    liked_by = models.ManyToManyField(to=User)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__str__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.title</span><br><span class="line">    </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ArticleSerializer</span>(serializers.ModelSerializer):</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Meta</span>:</span><br><span class="line">        model = Article</span><br><span class="line">        fields = <span class="string">&#x27;__all__&#x27;</span>    </span><br></pre></td></tr></table></figure></div>

<p>现在如果我们希望输出数据添加一个<code>total_likes</code>点赞总数的字段，我们只需要在序列化器类里重写<code>to_representation</code>方法</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ArticleSerializer</span>(serializers.ModelSerializer):</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Meta</span>:</span><br><span class="line">        model = Article</span><br><span class="line">        fields = <span class="string">&#x27;__all__&#x27;</span></span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">to_representation</span>(<span class="params">self, value</span>):</span><br><span class="line">        <span class="comment"># 调用父类获取当前序列化数据，value代表每个对象实例ob</span></span><br><span class="line">        data = <span class="built_in">super</span>().to_representation(value)</span><br><span class="line">        <span class="comment"># 对序列化数据做修改，添加新的数据</span></span><br><span class="line">        data[<span class="string">&#x27;total_likes&#x27;</span>] = value.liked_by.count()</span><br><span class="line">        <span class="keyword">return</span> data</span><br></pre></td></tr></table></figure></div>



<h4 id="使用嵌套序列化器"><a href="#使用嵌套序列化器" class="headerlink" title="使用嵌套序列化器"></a>使用嵌套序列化器</h4><p>目前我们文章中的author字段实际上对应的是一个User模型实例化后的对象，既不是一个整数id，也不是用户名这样一个简单字符串，我们可以使用嵌套序列化器显示更多用户对象信息</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">UserSerializer</span>(serializers.ModelSerializer):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Meta</span>:</span><br><span class="line">        model = User</span><br><span class="line">        fields = (<span class="string">&#x27;id&#x27;</span>, <span class="string">&#x27;username&#x27;</span>, <span class="string">&#x27;email&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ArticleSerializer</span>(serializers.ModelSerializer):</span><br><span class="line">    author = UserSerializer() <span class="comment"># required=False表示可接受匿名用户，many=True表示有多个用户。</span></span><br><span class="line">    status = serializers.ReadOnlyField(source=<span class="string">&quot;get_status_display&quot;</span>)</span><br><span class="line">    cn_status = serializers.SerializerMethodField()</span><br><span class="line">	,,,    </span><br></pre></td></tr></table></figure></div>

<p>其中我们还需要手动指定<code>read_only=True</code>这个选项。尽管我们在Meta选项已经指定了author为<code>read_only_fields</code>, 但使用嵌套序列化器时还需要重新指定一遍</p>
<h4 id="设置关联模型深度"><a href="#设置关联模型深度" class="headerlink" title="设置关联模型深度"></a>设置关联模型深度</h4><div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ArticleSerializer</span>(serializers.ModelSerializer):</span><br><span class="line">    <span class="comment"># author = UserSerializer(read_only=True) 	注释</span></span><br><span class="line">    status = serializers.ReadOnlyField(source=<span class="string">&quot;get_status_display&quot;</span>)</span><br><span class="line">    cn_status = serializers.SerializerMethodField()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Meta</span>:</span><br><span class="line">        model = Article</span><br><span class="line">        fields = <span class="string">&#x27;__all__&#x27;</span></span><br><span class="line">        read_only_fields = (<span class="string">&#x27;id&#x27;</span>, <span class="string">&#x27;author&#x27;</span>, <span class="string">&#x27;create_date&#x27;</span>)</span><br><span class="line">        depth = <span class="number">1</span> <span class="comment"># 注意这里</span></span><br><span class="line">	...</span><br></pre></td></tr></table></figure></div>

<p>这种方法虽然简便，但使用时要非常小心，因为它会展示关联模型中的所有字段。比如下例中连密码password都展示出来了，显然不是我们想要的</p>
<br>



<h3 id="关系序列化"><a href="#关系序列化" class="headerlink" title="关系序列化"></a>关系序列化</h3><p>若现在反过来要对用户信息进行序列化，要求返回信息里包含用户信息及所发表的文章列表，但用户User模型没有article这个字段，这时应该使用Django REST Framework提供的关系序列化方法。</p>
<h4 id="PrimaryKeyRelatedField"><a href="#PrimaryKeyRelatedField" class="headerlink" title="PrimaryKeyRelatedField"></a>PrimaryKeyRelatedField</h4><div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">UserSerializer</span>(serializers.ModelSerializer):</span><br><span class="line">    articles = serializers.PrimaryKeyRelatedField(many=<span class="literal">True</span>, read_only=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Meta</span>:</span><br><span class="line">        model = User</span><br><span class="line">        fields = (<span class="string">&#x27;id&#x27;</span>, <span class="string">&#x27;username&#x27;</span>, <span class="string">&#x27;articles&#x27;</span>,)</span><br><span class="line">        read_only_fields = (<span class="string">&#x27;id&#x27;</span>, <span class="string">&#x27;username&#x27;</span>,)</span><br></pre></td></tr></table></figure></div>



<h4 id="StringRelatedField"><a href="#StringRelatedField" class="headerlink" title="StringRelatedField"></a>StringRelatedField</h4><p>如果希望文章列表不以id形式展现，而是直接体现文章title，可以使用StringRelatedField</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">UserSerializer</span>(serializers.ModelSerializer):</span><br><span class="line">    articles = serializers.StringRelatedField(many=<span class="literal">True</span>, read_only=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Meta</span>:</span><br><span class="line">        model = User</span><br><span class="line">        fields = (<span class="string">&#x27;id&#x27;</span>, <span class="string">&#x27;username&#x27;</span>, <span class="string">&#x27;articles&#x27;</span>,)</span><br><span class="line">        read_only_fields = (<span class="string">&#x27;id&#x27;</span>, <span class="string">&#x27;username&#x27;</span>,)</span><br></pre></td></tr></table></figure></div>

<p><code>StringRelatedField</code>会直接返回每篇文章对象通过<code>__str__</code>方法定义的字段</p>
<h4 id="HyperlinkedRelatedField"><a href="#HyperlinkedRelatedField" class="headerlink" title="HyperlinkedRelatedField"></a>HyperlinkedRelatedField</h4><p>有时我们希望更进一步，不仅仅提供每篇文章的id或title列表，而是直接提供每篇文章对应的url列表，这样访问每个url可以获得更多关于文章的信息。这时就可以使用<code>HyperlinkedRelatedField</code>，它需要接收一个view的别名(本例为<code>article-detail</code>)</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">UserSerializer</span>(serializers.ModelSerializer):</span><br><span class="line">    articles = serializers.HyperlinkedRelatedField(</span><br><span class="line">        many=<span class="literal">True</span>,</span><br><span class="line">        read_only=<span class="literal">True</span>,</span><br><span class="line">        view_name=<span class="string">&#x27;article-detail&#x27;</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Meta</span>:</span><br><span class="line">        model = User</span><br><span class="line">        fields = (<span class="string">&#x27;id&#x27;</span>, <span class="string">&#x27;username&#x27;</span>, <span class="string">&#x27;articles&#x27;</span>,)</span><br><span class="line">        read_only_fields = (<span class="string">&#x27;id&#x27;</span>, <span class="string">&#x27;username&#x27;</span>,)</span><br></pre></td></tr></table></figure></div>

<p>其中注意要同步修改blog&#x2F;urls.py中的路由别名：<code> re_path(r&#39;^articles/(?P&lt;pk&gt;[0-9]+)$&#39;, views.ArticleDetail.as_view(), name=&#39;article-detail&#39;),</code></p>
<br>



<h3 id="数据验证（Validation）"><a href="#数据验证（Validation）" class="headerlink" title="数据验证（Validation）"></a>数据验证（Validation）</h3><p>在反序列化数据时，必需对用户提交的数据进行验证。在尝试访问经过验证的数据或保存对象实例之前，总是需要显示地调用 <code>is_valid()</code>方法。如果发生任何验证错误，<code>.errors</code> 属性将包含表示结果错误消息的字典，如下所示</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">serializer = CommentSerializer(data=&#123;<span class="string">&#x27;email&#x27;</span>: <span class="string">&#x27;foobar&#x27;</span>, <span class="string">&#x27;content&#x27;</span>: <span class="string">&#x27;baz&#x27;</span>&#125;)</span><br><span class="line">serializer.is_valid()</span><br><span class="line"><span class="comment"># False</span></span><br><span class="line">serializer.errors</span><br><span class="line"><span class="comment"># &#123;&#x27;email&#x27;: [u&#x27;Enter a valid e-mail address.&#x27;], &#x27;created&#x27;: [u&#x27;This field is required.&#x27;]&#125;</span></span><br></pre></td></tr></table></figure></div>

<p><code>.is_valid()</code> 方法使用可选的 <code>raise_exception</code> 标志，如果存在验证错误，将会抛出 <code>serializers.ValidationError</code> 异常</p>
<h4 id="字段级别验证"><a href="#字段级别验证" class="headerlink" title="字段级别验证"></a>字段级别验证</h4><p>我们可以通过向 <code>Serializer</code> 子类中添加 <code>.validate_&lt;field_name&gt;</code> 方法来指定自定义字段级的验证。这些类似于 Django 表单中的 <code>.clean_&lt;field_name&gt;</code> 方法。这些方法采用单个参数，即需要验证的字段值</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> serializers</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ArticleSerializer</span>(serializers.Serializer):</span><br><span class="line">    title = serializers.CharField(max_length=<span class="number">100</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">validate_title</span>(<span class="params">self, value</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Check that the article is about Django.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;django&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> value.lower():</span><br><span class="line">            <span class="keyword">raise</span> serializers.ValidationError(<span class="string">&quot;Article is not about Django&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> value</span><br></pre></td></tr></table></figure></div>

<p>如果在序列化器上声明了 <code>&lt;field_name&gt;</code> 的参数为 <code>required=False</code>，那么如果不包含该字段，则此验证步骤不会发生</p>
<h4 id="对象级别验证"><a href="#对象级别验证" class="headerlink" title="对象级别验证"></a>对象级别验证</h4><p>要执行需要访问多个字段的任何其他验证，可添加名为 <code>.validate()</code> 的方法到 <code>Serializer</code> 子类中。此方法采用单个参数，该参数是字段值的字典。如果需要，它应该抛出 <code>ValidationError</code> 异常，或者只返回经过验证的值</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> serializers</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">EventSerializer</span>(serializers.Serializer):</span><br><span class="line">    description = serializers.CharField(max_length=<span class="number">100</span>)</span><br><span class="line">    start = serializers.DateTimeField()</span><br><span class="line">    finish = serializers.DateTimeField()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">validate</span>(<span class="params">self, data</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Check that the start is before the stop.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> data[<span class="string">&#x27;start&#x27;</span>] &gt; data[<span class="string">&#x27;finish&#x27;</span>]:</span><br><span class="line">            <span class="keyword">raise</span> serializers.ValidationError(<span class="string">&quot;finish must occur after start&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> data</span><br></pre></td></tr></table></figure></div>



<h4 id="验证器"><a href="#验证器" class="headerlink" title="验证器"></a>验证器</h4><p>序列化器上的各个字段都可以包含验证器，通过在字段实例上声明</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">title_gt_90</span>(<span class="params">value</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(value) &lt; <span class="number">90</span>:</span><br><span class="line">        <span class="keyword">raise</span> serializers.ValidationError(<span class="string">&#x27;标题字符长度不低于90。&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Article</span>(serializers.Serializer):</span><br><span class="line">    title = seralizers.CharField(validators=[title_gt_90])</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure></div>

<p>DRF还提供了很多可重用的验证器，比如<code>UniqueValidator</code>,<code>UniqueTogetherValidator</code>等等。通过在内部 <code>Meta</code> 类上声明来包含这些验证器，如下所示。下例中会议房间号和日期的组合必须要是独一无二的</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">EventSerializer</span>(serializers.Serializer):</span><br><span class="line">    name = serializers.CharField()</span><br><span class="line">    room_number = serializers.IntegerField(choices=[<span class="number">101</span>, <span class="number">102</span>, <span class="number">103</span>, <span class="number">201</span>])</span><br><span class="line">    date = serializers.DateField()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Meta</span>:</span><br><span class="line">        <span class="comment"># Each room only has one event per day.</span></span><br><span class="line">        validators = UniqueTogetherValidator(</span><br><span class="line">            queryset=Event.objects.<span class="built_in">all</span>(),</span><br><span class="line">            fields=[<span class="string">&#x27;room_number&#x27;</span>, <span class="string">&#x27;date&#x27;</span>]</span><br><span class="line">        )</span><br></pre></td></tr></table></figure></div>


<br>



<h3 id="重写序列化器的create和update方法"><a href="#重写序列化器的create和update方法" class="headerlink" title="重写序列化器的create和update方法"></a>重写序列化器的create和update方法</h3><p>假设我们有个Profile模型与User模型是一对一的关系，当用户注册时我们希望把用户提交的数据分别存入User和Profile模型，这时我们就不得不重写序列化器自带的create方法了。下例演示了如何通过一个序列化器创建两个模型对象</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">UserSerializer</span>(serializers.ModelSerializer):</span><br><span class="line">    profile = ProfileSerializer()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Meta</span>:</span><br><span class="line">        model = User</span><br><span class="line">        fields = (<span class="string">&#x27;username&#x27;</span>, <span class="string">&#x27;email&#x27;</span>, <span class="string">&#x27;profile&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">create</span>(<span class="params">self, validated_data</span>):</span><br><span class="line">        profile_data = validated_data.pop(<span class="string">&#x27;profile&#x27;</span>)</span><br><span class="line">        user = User.objects.create(**validated_data)</span><br><span class="line">        Profile.objects.create(user=user, **profile_data)</span><br><span class="line">        <span class="keyword">return</span> user</span><br></pre></td></tr></table></figure></div>

<p>同时更新两个关联模型实例时也同样需要重写update方法</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">update</span>(<span class="params">self, instance, validated_data</span>):</span><br><span class="line">        profile_data = validated_data.pop(<span class="string">&#x27;profile&#x27;</span>)</span><br><span class="line">        profile = instance.profile</span><br><span class="line">        </span><br><span class="line">        instance.username = validated_data.get(<span class="string">&#x27;username&#x27;</span>, instance.username)</span><br><span class="line">        instance.email = validated_data.get(<span class="string">&#x27;email&#x27;</span>, instance.email)</span><br><span class="line">        instance.save()</span><br><span class="line"></span><br><span class="line">        profile.is_premium_member = profile_data.get(</span><br><span class="line">            <span class="string">&#x27;is_premium_member&#x27;</span>,</span><br><span class="line">            profile.is_premium_member</span><br><span class="line">        )</span><br><span class="line">        profile.has_support_contract = profile_data.get(</span><br><span class="line">            <span class="string">&#x27;has_support_contract&#x27;</span>,</span><br><span class="line">            profile.has_support_contract</span><br><span class="line">         )</span><br><span class="line">        profile.save()</span><br><span class="line">        <span class="keyword">return</span> instance</span><br></pre></td></tr></table></figure></div>

<p>因为序列化器使用嵌套后，创建和更新的行为可能不明确，并且可能需要相关模型之间的复杂依赖关系，REST framework要求你始终显式的编写这些方法。默认的 <code>ModelSerializer</code> <code>.create()</code> 和 <code>.update()</code>方法不包括对可写嵌套表示的支持，所以我们总是需要对create和update方法进行重写</p>
<br>



<h3 id="动态加载序列化器"><a href="#动态加载序列化器" class="headerlink" title="动态加载序列化器"></a>动态加载序列化器</h3><p>有时在类视图里不希望通过通过<code>serializer_class</code>指定固定的序列化器类，而是希望动态的加载序列化器，你可以重写<code>get_serializer_class</code>方法</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">UserViewSet</span>(CreateModelMixin,</span><br><span class="line">                  RetrieveModelMixin,UpdateModelMixin,viewsets.GenericViewSet):</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 这个就不需要了</span></span><br><span class="line">    <span class="comment">#serializer_class = XXXSerializer</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_serializer_class</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.action == <span class="string">&#x27;create&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> CustomSerializer1</span><br><span class="line">        <span class="keyword">elif</span> <span class="variable language_">self</span>.action == <span class="string">&#x27;list&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> XXXSerializer</span><br><span class="line">        <span class="keyword">return</span> CustomSerializer1</span><br></pre></td></tr></table></figure></div>



<hr>
<h2 id="认证与权限"><a href="#认证与权限" class="headerlink" title="认证与权限"></a>认证与权限</h2><p>目前的 API 对谁可以新增、编辑或删除文章资源(Article)没有限制，本节中希望通过基本的认证(Authentication)与权限(Permission)来实现一些更实用的功能：</p>
<ul>
<li>只有经过身份验证的用户可以创建article文章(匿名用户不允许通过POST提交新文章)</li>
<li>未经身份验证的请求应具有完全只读访问权限</li>
<li>单篇article资源始终与创建者相关联，只有 article 的创建者可以更新或删除它</li>
</ul>
<br>


<h3 id="认证与权限的区别"><a href="#认证与权限的区别" class="headerlink" title="认证与权限的区别"></a>认证与权限的区别</h3><p>认证(Authentication)与权限(Permission)不是一回事。认证是通过用户提供的用户ID&#x2F;密码组合或者Token来验证用户的身份。权限(Permission)的校验发生验证用户身份以后，是由系统根据分配权限确定用户可以访问何种资源以及对这种资源进行何种操作，这个过程也被称为授权(Authorization)</p>
<p>无论是Django还是DRF, 当用户成功通过身份验证以后，系统会把已通过验证的用户对象与request请求绑定，这样一来你就可以使用<code>request.user</code>获取这个用户对象的所有信息了</p>
<br>




<h3 id="给视图添加权限"><a href="#给视图添加权限" class="headerlink" title="给视图添加权限"></a>给视图添加权限</h3><p>在Django传统视图开发中你可能会使用<code>@login_required</code>和<code>@permission_required</code>这样的装饰器要求用户先登录或进行权限验证</p>
<p>在DRF中你不需要做，这是因为REST framework 包含许多默认权限类，我们可以用来限制谁可以访问给定的视图。在这种情况下，我们需要的是 <code>IsAuthenticatedOrReadOnly</code> 类，它将确保经过身份验证的请求获得读写访问权限，未经身份验证的请求将获得只读读的权限。</p>
<p>修改blog&#x2F;views.py：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> generics</span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> permissions</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ArticleList</span>(generics.ListCreateAPIView):</span><br><span class="line">    queryset = Article.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class = ArticleSerializer</span><br><span class="line">    permission_classes = (permissions.IsAuthenticatedOrReadOnly,)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 手动绑定</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">perform_create</span>(<span class="params">self, serializer</span>):</span><br><span class="line">        serializer.save(author=<span class="variable language_">self</span>.request.user)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ArticleDetail</span>(generics.RetrieveUpdateDestroyAPIView):</span><br><span class="line">    queryset = Article.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class =ArticleSerializer</span><br><span class="line">    permission_classes = (permissions.IsAuthenticatedOrReadOnly,)</span><br></pre></td></tr></table></figure></div>

<p>此时退出登录，再访问文章资源列表或单篇文章资源时，你会看到红色的delete按钮和添加修改表单都已消失，当重新登录验证身份后，你又可以看到delete按钮和修改表单了</p>
<p>DRF中你可以将登录页面<code>api-auth</code>添加到你的项目urls中，然后访问<code>api-auth/login/</code>就可以看到专门的DRF的登录页面</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.contrib <span class="keyword">import</span> admin</span><br><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path, include</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    path(<span class="string">&#x27;admin/&#x27;</span>, admin.site.urls),</span><br><span class="line">    path(<span class="string">&#x27;v1/&#x27;</span>, include(<span class="string">&#x27;blog.urls&#x27;</span>)),</span><br><span class="line">    path(<span class="string">&#x27;api-auth/&#x27;</span>, include(<span class="string">&#x27;rest_framework.urls&#x27;</span>)), <span class="comment"># 用户登录页面</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure></div>

<br>




<h3 id="DRF自带权限类"><a href="#DRF自带权限类" class="headerlink" title="DRF自带权限类"></a>DRF自带权限类</h3><p>除了<code>IsAuthenticatedOrReadOnly</code> 类，DRF自带的常用权限类还包括：</p>
<ul>
<li><code>IsAuthenticated</code>类：仅限已经通过身份验证的用户访问；</li>
<li><code>AllowAny</code>类：允许任何用户访问；</li>
<li><code>IsAdminUser</code>类：仅限管理员访问；</li>
<li><code>DjangoModelPermissions</code>类：只有在用户经过身份验证并分配了相关模型权限时，才会获得授权访问相关模型。</li>
<li><code>DjangoModelPermissionsOrReadOnly</code>类：与前者类似，但可以给匿名用户访问API的可读权限。</li>
<li><code>DjangoObjectPermissions</code>类：只有在用户经过身份验证并分配了相关对象权限时，才会获得授权访问相关对象。通常与django-gaurdian联用实现对象级别的权限控制。</li>
</ul>
<br>



<h3 id="自定义权限"><a href="#自定义权限" class="headerlink" title="自定义权限"></a>自定义权限</h3><p>大多数情况下，默认的权限类不能满足我们的要求，这时就需要自定义权限了。自定义的权限类需要继承<code>BasePermission</code>类并根据需求重写<code>has_permission(self,request,view)</code>和<code>has_object_permission(self,request, view, obj)</code>方法。你还可以通过<code>message</code>自定义返回的错误信息</p>
<p>之前<code>IsAuthenticatedOrReadOnly</code> 类并不能实现只有文章 article 的创建者才可以更新或删除它，这时我们还需要自定义一个名为<code>IsOwnerOrReadOnly</code> 的权限类，把它加入到ArticleDetail视图里</p>
<p>在blog文件夹下创建<code>permissions.py</code>，添加如下代码：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> permissions</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">IsOwnerOrReadOnly</span>(permissions.BasePermission):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    自定义权限只允许对象的创建者才能编辑它。</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">has_object_permission</span>(<span class="params">self, request, view, obj</span>):</span><br><span class="line">        <span class="comment"># 读取权限被允许用于任何请求，</span></span><br><span class="line">        <span class="comment"># 所以我们始终允许 GET，HEAD 或 OPTIONS 请求。</span></span><br><span class="line">        <span class="keyword">if</span> request.method <span class="keyword">in</span> permissions.SAFE_METHODS:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="comment"># 写入权限只允许给 article 的作者。</span></span><br><span class="line">        <span class="keyword">return</span> obj.author == request.user</span><br></pre></td></tr></table></figure></div>

<p>然后修改我们的视图，<code>IsOwnerOrReadOnly</code> 的权限类，把它加入到ArticleDetail视图的<code>permission_classes</code>里</p>
<p>DRF支持权限类的插拔</p>
<br>



<h3 id="更多设置权限方式"><a href="#更多设置权限方式" class="headerlink" title="更多设置权限方式"></a>更多设置权限方式</h3><p>在前面的案例中，我们都是在基于类的API视图里通过<code>permission_classes</code>属性设置的权限类。如果你有些权限是全局或全站通用的，你还可以在settings.py中使用 <code>DEFAULT_PERMISSION_CLASSES</code> 全局设置默认权限策略。</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">REST_FRAMEWORK = &#123;</span><br><span class="line">    <span class="string">&#x27;DEFAULT_PERMISSION_CLASSES&#x27;</span>: (</span><br><span class="line">        <span class="string">&#x27;rest_framework.permissions.IsAuthenticated&#x27;</span>,</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>如果未指定，则此设置默认为允许无限制访问</p>
<p>如果习惯使用基于函数的视图编写API，可以按如下方式给你的函数视图添加权限。</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.decorators <span class="keyword">import</span> api_view, permission_classes</span><br><span class="line"><span class="keyword">from</span> rest_framework.permissions <span class="keyword">import</span> IsAuthenticated</span><br><span class="line"><span class="keyword">from</span> rest_framework.response <span class="keyword">import</span> Response</span><br><span class="line"></span><br><span class="line"><span class="meta">@api_view(<span class="params">[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="meta">@permission_classes(<span class="params">(<span class="params">IsAuthenticated, </span>)</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">example_view</span>(<span class="params">request, <span class="built_in">format</span>=<span class="literal">None</span></span>):</span><br><span class="line">    content = &#123;</span><br><span class="line">        <span class="string">&#x27;status&#x27;</span>: <span class="string">&#x27;request was permitted&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Response(content)</span><br></pre></td></tr></table></figure></div>

<p>当你通过类属性或装饰器设置新的权限类时，视图会覆盖<code> settings.py</code> 中设置的默认权限。</p>
<br>


<hr>
<br>


<h2 id="认证详解与token认证"><a href="#认证详解与token认证" class="headerlink" title="认证详解与token认证"></a>认证详解与token认证</h2><p>前一部分我们使用了Django默认的基于session的认证方式，实际前后端分离开发项目中后台更多采用的是token(令牌认证)</p>
<h3 id="认证"><a href="#认证" class="headerlink" title="认证"></a>认证</h3><p>身份验证是将传入的请求对象(request)与一组标识凭据（例如用户名+密码或者令牌token）相关联的机制。REST framework 提供了一些开箱即用的身份验证方案，并且还允许你实现自定义方案</p>
<p>DRF的每个认证方案实际上是一个类。你可以在视图中使用一个或多个认证方案类。REST framework 将尝试使用列表中的每个类进行身份验证，并使用成功完成验证的第一个类的返回的元组设置 <code>request.user</code> 和<code>request.auth</code></p>
<p>用户通过认证后<code>request.user</code>返回Django的User实例，否则返回<code>AnonymousUser</code>的实例。<code>request.auth</code>通常为None。如果使用token认证，<code>request.auth</code>可以包含认证过的token</p>
<br>



<h3 id="DRF自带认证方案"><a href="#DRF自带认证方案" class="headerlink" title="DRF自带认证方案"></a>DRF自带认证方案</h3><p>Django REST Framework提供了如下几种认证方案:</p>
<ul>
<li>Session认证<code>SessionAuthentication</code>类：此认证方案使用Django的默认session后端进行身份验证。当客户端发送登录请求通过验证后，Django通过session将用户信息存储在服务器中保持用户的请求状态。Session身份验证适用于与你的网站在相同的Session环境中运行的AJAX客户端 (注：这也是Session认证的最大弊端)</li>
<li>基本认证<code>BasicAuthentication</code>类：此认证方案使用HTTP 基本认证，针对用户的用户名和密码进行认证。使用这种方式后浏览器会跳出登录框让用户输入用户名和密码认证。基本认证通常只适用于测试</li>
<li>远程认证<code>RemoteUserAuthentication</code>类：此认证方案为用户名不存在的用户自动创建用户实例。这个很少用，具体见文档</li>
<li>Token认证<code>TokenAuthentication</code>类：该认证方案是DRF提供的使用简单的基于Token的HTTP认证方案。当客户端发送登录请求时，服务器便会生成一个Token并将此Token返回给客户端，作为客户端进行请求的一个标识。以后客户端只需带上这个Token前来请求数据即可，无需再次带上用户名和密码。后面我们会详细介绍如何使用这种认证方案</li>
</ul>
<br>



<h3 id="DRF中设置认证方案"><a href="#DRF中设置认证方案" class="headerlink" title="DRF中设置认证方案"></a>DRF中设置认证方案</h3><h4 id="设置默认的全局认证方案"><a href="#设置默认的全局认证方案" class="headerlink" title="设置默认的全局认证方案"></a>设置默认的全局认证方案</h4><div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># settings.py</span></span><br><span class="line"></span><br><span class="line">REST_FRAMEWORK = &#123;</span><br><span class="line">    <span class="string">&#x27;DEFAULT_AUTHENTICATION_CLASSES&#x27;</span>: (</span><br><span class="line">        <span class="string">&#x27;rest_framework.authentication.BasicAuthentication&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;rest_framework.authentication.SessionAuthentication&#x27;</span>,</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>



<h4 id="在基于类的视图-CBV-中使用"><a href="#在基于类的视图-CBV-中使用" class="headerlink" title="在基于类的视图(CBV)中使用"></a>在基于类的视图(CBV)中使用</h4><div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.authentication <span class="keyword">import</span> SessionAuthentication, BasicAuthentication</span><br><span class="line"><span class="keyword">from</span> rest_framework.permissions <span class="keyword">import</span> IsAuthenticated</span><br><span class="line"><span class="keyword">from</span> rest_framework.response <span class="keyword">import</span> Response</span><br><span class="line"><span class="keyword">from</span> rest_framework.views <span class="keyword">import</span> APIView</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ExampleView</span>(<span class="title class_ inherited__">APIView</span>):</span><br><span class="line">    authentication_classes = (SessionAuthentication, BasicAuthentication)</span><br><span class="line">    permission_classes = (IsAuthenticated,)</span><br></pre></td></tr></table></figure></div>



<h4 id="在基于函数的视图中使用"><a href="#在基于函数的视图中使用" class="headerlink" title="在基于函数的视图中使用"></a>在基于函数的视图中使用</h4><div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.decorators <span class="keyword">import</span> api_view, authentication_classes, permission_classes</span><br><span class="line"></span><br><span class="line"><span class="meta">@api_view(<span class="params">[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="meta">@authentication_classes(<span class="params">(<span class="params">SessionAuthentication, BasicAuthentication</span>)</span>)</span></span><br><span class="line"><span class="meta">@permission_classes(<span class="params">(<span class="params">IsAuthenticated,</span>)</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">example_view</span>(<span class="params">request, <span class="built_in">format</span>=<span class="literal">None</span></span>):</span><br><span class="line">    content = &#123;</span><br><span class="line">        <span class="string">&#x27;user&#x27;</span>: unicode(request.user),  <span class="comment"># `django.contrib.auth.User` 实例。</span></span><br><span class="line">        <span class="string">&#x27;auth&#x27;</span>: unicode(request.auth),  <span class="comment"># None</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Response(content)</span><br></pre></td></tr></table></figure></div>


<br>



<h3 id="自定义认证方案"><a href="#自定义认证方案" class="headerlink" title="自定义认证方案"></a>自定义认证方案</h3><p>要实现自定义的认证方案，首先要继承<code>BaseAuthentication</code>类并且重写<code>.authenticate(self, request)</code>方法。如果认证成功，该方法应返回<code>(user, auth)</code>的二元元组，否则返回<code>None</code></p>
<p>在某些情况下，你可能不想返回<code>None</code>，而是希望从<code>.authenticate()</code>方法抛出<code>AuthenticationFailed</code>异常。通常你应该采取的方法是：</p>
<ul>
<li>如果不尝试验证，返回<code>None</code>。还将检查任何其他正在使用的身份验证方案</li>
<li>如果尝试验证但失败，则抛出<code>AuthenticationFailed</code>异常。无论任何权限检查也不检查任何其他身份验证方案，立即返回错误响应</li>
</ul>
<p>你也可以重写<code>.authenticate_header(self, request)</code>方法。如果实现该方法，则应返回一个字符串，该字符串将用作<code>HTTP 401 Unauthorized</code>响应中的<code>WWW-Authenticate</code>头的值。如果<code>.authenticate_header()</code>方法未被重写，则认证方案将在未验证的请求被拒绝访问时返回<code>HTTP 403 Forbidden</code>响应。</p>
<p>以下示例将以自定义请求头中名称为’X_USERNAME’提供的用户名作为用户对任何传入请求进行身份验证，其它类似自定义认证需求比如支持用户同时按用户名或email进行验证。</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.contrib.auth.models <span class="keyword">import</span> User</span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> authentication</span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> exceptions</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ExampleAuthentication</span>(authentication.BaseAuthentication):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">authenticate</span>(<span class="params">self, request</span>):</span><br><span class="line">        username = request.META.get(<span class="string">&#x27;X_USERNAME&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> username:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            user = User.objects.get(username=username)</span><br><span class="line">        <span class="keyword">except</span> User.DoesNotExist:</span><br><span class="line">            <span class="keyword">raise</span> exceptions.AuthenticationFailed(<span class="string">&#x27;No such user&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> (user, <span class="literal">None</span>)</span><br></pre></td></tr></table></figure></div>


<br>



<h3 id="前后端分离时为何推荐token认证"><a href="#前后端分离时为何推荐token认证" class="headerlink" title="前后端分离时为何推荐token认证"></a>前后端分离时为何推荐token认证</h3><ul>
<li>Token无需存储降低服务器成本，session是将用户信息存储在服务器中的，当用户量增大时服务器的压力也会随着增大。</li>
<li>防御CSRF跨站伪造请求攻击，session是基于cookie进行用户识别的, cookie如果被截获，用户信息就容易泄露。</li>
<li>扩展性强，session需要存储无法共享，当搭建了多个服务器时其他服务器无法获取到session中的验证数据用户无法验证成功。Token可以实现服务器间共享，这样不管哪里都可以访问到。</li>
<li>Token可以减轻服务器的压力，减少频繁的查询数据库。</li>
<li>支持跨域访问, 适用于移动平台应用</li>
</ul>
<br>




<h3 id="TokenAuthentication"><a href="#TokenAuthentication" class="headerlink" title="TokenAuthentication"></a>TokenAuthentication</h3><p>DRF自带的<code>TokenAuthentication</code>方案可以实现基本的token认证，整个流程如下：</p>
<h4 id="初始设置"><a href="#初始设置" class="headerlink" title="初始设置"></a>初始设置</h4><p>修改<code>settings.py</code>， 加入如下app并设置认证方式</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">INSTALLED_APPS = (</span><br><span class="line">    ...</span><br><span class="line">    <span class="string">&#x27;rest_framework.authtoken&#x27;</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">REST_FRAMEWORK = &#123;</span><br><span class="line">    <span class="string">&#x27;DEFAULT_AUTHENTICATION_CLASSES&#x27;</span>: (</span><br><span class="line">        <span class="string">&#x27;rest_framework.authentication.TokenAuthentication&#x27;</span>,</span><br><span class="line">    ),</span><br></pre></td></tr></table></figure></div>

<p>同时不要忘记做一次数据库迁移<code>python manage.py migrate</code>，生成token表</p>
<h4 id="生成token"><a href="#生成token" class="headerlink" title="生成token"></a>生成token</h4><p>下面几种方法可以为用户生成令牌(token)</p>
<ol>
<li>可以借助Django的信号(signals)实现创建用户时自动生成token（具体操作请参考信号量篇章，此处不全）</li>
</ol>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.conf <span class="keyword">import</span> settings</span><br><span class="line"><span class="keyword">from</span> django.db.models.signals <span class="keyword">import</span> post_save</span><br><span class="line"><span class="keyword">from</span> django.dispatch <span class="keyword">import</span> receiver</span><br><span class="line"><span class="keyword">from</span> rest_framework.authtoken.models <span class="keyword">import</span> Token</span><br><span class="line"></span><br><span class="line"><span class="meta">@receiver(<span class="params">post_save, sender=settings.AUTH_USER_MODEL</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_auth_token</span>(<span class="params">sender, instance=<span class="literal">None</span>, created=<span class="literal">False</span>, **kwargs</span>):</span><br><span class="line">    <span class="keyword">if</span> created:</span><br><span class="line">        Token.objects.create(user=instance)</span><br></pre></td></tr></table></figure></div>

<ol start="2">
<li>如果你已经创建了一些用户，则可以运行<code>python manage.py shell</code>，并运行下面代码，为所有现有用户生成令牌</li>
</ol>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.contrib.auth.models <span class="keyword">import</span> User</span><br><span class="line"><span class="keyword">from</span> rest_framework.authtoken.models <span class="keyword">import</span> Token</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> user <span class="keyword">in</span> User.objects.<span class="built_in">all</span>():    </span><br><span class="line">    Token.objects.get_or_create(user=user)</span><br></pre></td></tr></table></figure></div>

<ol start="3">
<li>还可以在<code>admin.py</code>中给用户创建token</li>
</ol>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.authtoken.admin <span class="keyword">import</span> TokenAdmin</span><br><span class="line">TokenAdmin.raw_id_fields = [<span class="string">&#x27;user&#x27;</span>]</span><br></pre></td></tr></table></figure></div>

<ol start="4">
<li>从3.6.4起，你还可以使用如下命令为一个指定用户新建或重置token</li>
</ol>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">python manage.py drf_create_token &lt;username&gt; 		<span class="comment"># 新建</span></span><br><span class="line">python manage.py drf_create_token -r &lt;username&gt; 	<span class="comment"># 重置</span></span><br></pre></td></tr></table></figure></div>



<h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h4><p>需要注意，DRF自带的API在此处可能不太好用，因为DRF 默认的登录方式是基于会话的，而不是基于 Token 的，故下面我们使用curl来测试</p>
<p>首先需要暴露用户获取token的url地址(API端点)，在项目的urls.py中加入</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.authtoken <span class="keyword">import</span> views</span><br><span class="line"></span><br><span class="line">	...</span><br><span class="line">    path(<span class="string">&#x27;api-token-auth/&#x27;</span>, views.obtain_auth_token)</span><br></pre></td></tr></table></figure></div>

<p>这样每当用户使用form表单或JSON将有效的<code>username</code>和<code>password</code>字段POST提交到以上视图时，<code>obtain_auth_token</code>视图将响应</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST -d <span class="string">&quot;username=yyb&amp;password=123&quot;</span> http://127.0.0.1:8000/api-token-auth/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 返回： &#123;&quot;token&quot;:&quot;257e09eda99e3bb9a1468aeffbeb2abcf6509f55&quot;&#125;%                                                  </span></span><br></pre></td></tr></table></figure></div>

<p>客户端拿到token后可以将其存储到本地cookie或localstorage里，下次发送请求时把token包含在<code>Authorization</code>HTTP头即可，可以通过curl工具来进行简单测试</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -X GET http://127.0.0.1:8000/v1/articles/ -H <span class="string">&#x27;Authorization: Token 257e09eda99e3bb9a1468aeffbeb2abcf6509f55&#x27;</span></span><br></pre></td></tr></table></figure></div>

<p>这里先关闭articles视图中的未登陆可读权限可能更明显一些</p>
<h4 id="自定义Token返回信息"><a href="#自定义Token返回信息" class="headerlink" title="自定义Token返回信息"></a>自定义Token返回信息</h4><p>默认的<code>obtain_auth_token</code>视图返回的json响应数据是非常简单的，只有token一项。如果你希望返回更多信息，比如用户id或email，就就要通过继承<code>ObtainAuthToken</code>类量身定制这个视图，可在<code>views.py</code>中增加</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.authtoken.views <span class="keyword">import</span> ObtainAuthToken</span><br><span class="line"><span class="keyword">from</span> rest_framework.authtoken.models <span class="keyword">import</span> Token</span><br><span class="line"><span class="keyword">from</span> rest_framework.response <span class="keyword">import</span> Response</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CustomAuthToken</span>(<span class="title class_ inherited__">ObtainAuthToken</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">post</span>(<span class="params">self, request, *args, **kwargs</span>):</span><br><span class="line">        serializer = <span class="variable language_">self</span>.serializer_class(data=request.data,</span><br><span class="line">                                           context=&#123;<span class="string">&#x27;request&#x27;</span>: request&#125;)</span><br><span class="line">        serializer.is_valid(raise_exception=<span class="literal">True</span>)</span><br><span class="line">        user = serializer.validated_data[<span class="string">&#x27;user&#x27;</span>]</span><br><span class="line">        token, created = Token.objects.get_or_create(user=user)</span><br><span class="line">        <span class="keyword">return</span> Response(&#123;</span><br><span class="line">            <span class="string">&#x27;token&#x27;</span>: token.key,</span><br><span class="line">            <span class="string">&#x27;user_id&#x27;</span>: user.pk,</span><br><span class="line">            <span class="string">&#x27;email&#x27;</span>: user.email</span><br><span class="line">        &#125;)</span><br></pre></td></tr></table></figure></div>

<p>然后在<code>urls.py</code>中更改：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> blog.views <span class="keyword">import</span> CustomAuthToken</span><br><span class="line">	path(<span class="string">&#x27;api-token-auth/&#x27;</span>, CustomAuthToken.as_view())</span><br></pre></td></tr></table></figure></div>

<p>最后一步，DRF的<code>TokenAuthentication</code>类会从请求头中获取Token，验证其有效性。如果token有效，返回<code>request.user</code>。</p>
<br>


<hr>
<br>


<h2 id="JWT认证"><a href="#JWT认证" class="headerlink" title="JWT认证"></a>JWT认证</h2><p>JSON Web Token(JWT)是一种更新的使用token进行身份认证的标准。与DRF内置的TokenAuthentication方案不同，JWT身份验证不需要使用数据库来验证令牌, 而且可以轻松设置token失效期或刷新token, 是API开发中当前最流行的跨域认证解决方案</p>
<p>这部分将详细介绍JWT认证的工作原理以及如何通过<code>djangorestframework-simplejwt</code> 这个第三方包轻松实现JWT认证（相应的第三方包还有很多，我在python课程大作业开发中使用的就是<code>jwt</code>这一第三方包）</p>
<br>


<h3 id="Json-Web-Token介绍"><a href="#Json-Web-Token介绍" class="headerlink" title="Json Web Token介绍"></a>Json Web Token介绍</h3><p>JSON Web Token（JWT）是一种开放标准，它定义了一种紧凑且自包含的方式，用于各方之间安全地将信息以JSON对象传输。由于此信息是经过数字签名的，因此可以被验证和信任。JWT用于为应用程序创建访问token，通常适用于API身份验证和服务器到服务器的授权。那么如何理解紧凑和自包含这两个词的含义呢?</p>
<ul>
<li><strong>紧凑</strong>：就是说这个数据量比较少，可以通过url参数，http请求提交的数据以及http header多种方式来传递。</li>
<li><strong>自包含</strong>：这个字符串可以包含很多信息，比如用户id，用户名，订单号id等，如果其他人拿到该信息，就可以拿到关键业务信息。</li>
</ul>
<p>那么JWT认证是如何工作的呢? 首先客户端提交用户登录信息验证身份通过后，服务器生成一个用于证明用户身份的令牌(token)，也就是一个加密后的长字符串，并将其发送给客户端。在后续请求中，客户端以各种方式(比如通过url参数或者请求头)将这个令牌发送回服务器，服务器就知道请求来自哪个特定身份的用户了。</p>
<p>JSON Web Token由三部分组成，这些部分由点（.）分隔，分别是header(头部)，payload(有效负载)和signature(签名)。</p>
<ul>
<li>header(头部)：识别以何种算法来生成签名</li>
<li>pyload(有效负载)：用来存放实际需要传递的数据</li>
<li>signature(签名)：安全验证token有效性，防止数据被篡改</li>
</ul>
<p>通过http传输的数据实际上是加密后的JWT，它是由两个点分割的base64-URL长字符串组成，解密后我们可以得到header, payload和signature三部分。我们可以简单的使用 <a class="link"   target="_blank" rel="noopener" href="https://jwt.io/" >https://jwt.io/ <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> 官网来生成或解析一个JWT</p>
<br>


<h3 id="DRF中使用JWT认证"><a href="#DRF中使用JWT认证" class="headerlink" title="DRF中使用JWT认证"></a>DRF中使用JWT认证</h3><h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><p><code>django-rest-framework-simplejwt</code>库为DRF提供了JWT认证后端。它提供了一组保守的默认功能来涵盖了JWT的最常见用例，而且非常容易扩展。首先使用pip安装它</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install djangorestframework-simplejwt</span><br></pre></td></tr></table></figure></div>



<h4 id="应用"><a href="#应用" class="headerlink" title="应用"></a>应用</h4><p>我们需要告诉DRF我们使用jwt认证作为后台认证方案。修改<code>apiproject/settings.py</code>：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">REST_FRAMEWORK = &#123;</span><br><span class="line">    <span class="string">&#x27;DEFAULT_AUTHENTICATION_CLASSES&#x27;</span>: [</span><br><span class="line">        <span class="string">&#x27;rest_framework_simplejwt.authentication.JWTAuthentication&#x27;</span>,</span><br><span class="line">    ],</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>最后，我们需要提供用户可以获取和刷新token的urls地址，这两个urls分别对应<code>TokenObtainPairView</code>和<code>TokenRefreshView</code>两个视图，这部分涉及双token的设计方式，可观看双token博客部分</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.contrib <span class="keyword">import</span> admin</span><br><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path, include</span><br><span class="line"><span class="keyword">from</span> reviews.views <span class="keyword">import</span> ProductViewSet, ImageViewSet</span><br><span class="line"><span class="keyword">from</span> rest_framework.routers <span class="keyword">import</span> DefaultRouter</span><br><span class="line"><span class="keyword">from</span> django.conf <span class="keyword">import</span> settings</span><br><span class="line"><span class="keyword">from</span> django.conf.urls.static <span class="keyword">import</span> static</span><br><span class="line"><span class="keyword">from</span> rest_framework_simplejwt.views <span class="keyword">import</span> (</span><br><span class="line">    TokenObtainPairView,</span><br><span class="line">    TokenRefreshView,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">router = DefaultRouter()</span><br><span class="line">router.register(<span class="string">r&#x27;product&#x27;</span>, ProductViewSet, basename=<span class="string">&#x27;Product&#x27;</span>)</span><br><span class="line">router.register(<span class="string">r&#x27;image&#x27;</span>, ImageViewSet, basename=<span class="string">&#x27;Image&#x27;</span>)</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    path(<span class="string">&#x27;admin/&#x27;</span>, admin.site.urls),</span><br><span class="line">    path(<span class="string">&#x27;token/&#x27;</span>, TokenObtainPairView.as_view(), name=<span class="string">&#x27;token_obtain_pair&#x27;</span>),</span><br><span class="line">    path(<span class="string">&#x27;token/refresh/&#x27;</span>, TokenRefreshView.as_view(), name=<span class="string">&#x27;token_refresh&#x27;</span>),</span><br><span class="line">    path(<span class="string">&#x27;&#x27;</span>, include(router.urls)),</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> settings.DEBUG:</span><br><span class="line">    urlpatterns += static(settings.MEDIA_URL, document_root=settings.MEDIA_ROOT)</span><br></pre></td></tr></table></figure></div>



<h4 id="测试-1"><a href="#测试-1" class="headerlink" title="测试"></a>测试</h4><p>现在我们可以开始使用curl测试，通过POST方法发送登录请求到&#x2F;token&#x2F;，请求数据包括username和password。如果登录成功，你将得到两个长字符串，一个是access token(访问令牌)，还有一个是refresh token(刷新令牌)</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST -d <span class="string">&quot;username=yyb&amp;password=123&quot;</span> http://127.0.0.1:8000/token/ </span><br><span class="line"></span><br><span class="line"><span class="comment"># 返回： &#123;&quot;refresh&quot;:&quot;eyJ...,&quot;access&quot;:&quot;eyJ...&quot;&#125;%   </span></span><br></pre></td></tr></table></figure></div>

<p>假如你有一个受保护的视图，权限(permission_classes)是<code>IsAuthenticated</code>，只有验证用户才可访问。访问这个保护视图时你只需要在请求头的Authorization选项里输入你刚才获取的access token即可（注意默认设置要求在请求头中使用 <code>Bearer</code> 作为前缀来传递 Token）</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -X GET http://127.0.0.1:8000/v1/articles/ -H <span class="string">&#x27;Authorization: Bearer eyJhbGci...&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 返回：[&#123;&quot;id&quot;:12,&quot;author&quot;:&#123;&quot;id&quot;:1,&quot;username&quot;:&quot;yyb&quot;,&quot;articles...</span></span><br></pre></td></tr></table></figure></div>

<p>不过这个access token默认只有5分钟有效。5分钟过后，当你再次访问保护视图时，你将得到如下token已失效或过期的提示</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -X GET http://127.0.0.1:8000/v1/articles/ -H <span class="string">&#x27;Authorization: Bearer eyJhbGci...&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 返回：&#123;&quot;detail&quot;:&quot;Given token not valid for any token type&quot;,&quot;code&quot;:&quot;token_not_valid&quot;,&quot;messages&quot;:[&#123;&quot;token_class&quot;:&quot;AccessToken&quot;,&quot;token_type&quot;:&quot;access&quot;,&quot;message&quot;:&quot;Token is invalid or expired&quot;&#125;]&#125;%   </span></span><br></pre></td></tr></table></figure></div>

<p>去获取新的access token，你需要使用之前获得的refresh token。你将这个refresh token放到请求的正文(body)里，发送POST请求到<code>/token/refresh/</code>即可获得刷新后的access token(访问令牌)</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST http://127.0.0.1:8000/token/refresh/ -d <span class="string">&#x27;&#123;&quot;refresh&quot;: &quot;eyJhbGciOiJI...&quot;&#125;&#x27;</span> -H <span class="string">&quot;Content-Type: application/json&quot;</span></span><br><span class="line">&#123;<span class="string">&quot;access&quot;</span>:<span class="string">&quot;eyJhbGciOiJ...&quot;</span>&#125;%       </span><br></pre></td></tr></table></figure></div>

<p>Simple JWT中的access token默认有效期是5分钟，refresh token默认有效期是24小时</p>
<br>



<h3 id="Simple-JWT的默认设置"><a href="#Simple-JWT的默认设置" class="headerlink" title="Simple JWT的默认设置"></a>Simple JWT的默认设置</h3><p>Simple JWT的默认设置如下所示：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">DEFAULTS = &#123;</span><br><span class="line">    <span class="string">&#x27;ACCESS_TOKEN_LIFETIME&#x27;</span>: timedelta(minutes=<span class="number">5</span>),</span><br><span class="line">    <span class="string">&#x27;REFRESH_TOKEN_LIFETIME&#x27;</span>: timedelta(days=<span class="number">1</span>),</span><br><span class="line">    <span class="string">&#x27;ROTATE_REFRESH_TOKENS&#x27;</span>: <span class="literal">False</span>,</span><br><span class="line">    <span class="string">&#x27;BLACKLIST_AFTER_ROTATION&#x27;</span>: <span class="literal">True</span>,</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;ALGORITHM&#x27;</span>: <span class="string">&#x27;HS256&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;SIGNING_KEY&#x27;</span>: settings.SECRET_KEY,</span><br><span class="line">    <span class="string">&#x27;VERIFYING_KEY&#x27;</span>: <span class="literal">None</span>,</span><br><span class="line">    <span class="string">&#x27;AUDIENCE&#x27;</span>: <span class="literal">None</span>,</span><br><span class="line">    <span class="string">&#x27;ISSUER&#x27;</span>: <span class="literal">None</span>,</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;AUTH_HEADER_TYPES&#x27;</span>: (<span class="string">&#x27;Bearer&#x27;</span>,),</span><br><span class="line">    <span class="string">&#x27;USER_ID_FIELD&#x27;</span>: <span class="string">&#x27;id&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;USER_ID_CLAIM&#x27;</span>: <span class="string">&#x27;user_id&#x27;</span>,</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;AUTH_TOKEN_CLASSES&#x27;</span>: (<span class="string">&#x27;rest_framework_simplejwt.tokens.AccessToken&#x27;</span>,),</span><br><span class="line">    <span class="string">&#x27;TOKEN_TYPE_CLAIM&#x27;</span>: <span class="string">&#x27;token_type&#x27;</span>,</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;JTI_CLAIM&#x27;</span>: <span class="string">&#x27;jti&#x27;</span>,</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;SLIDING_TOKEN_REFRESH_EXP_CLAIM&#x27;</span>: <span class="string">&#x27;refresh_exp&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;SLIDING_TOKEN_LIFETIME&#x27;</span>: timedelta(minutes=<span class="number">5</span>),</span><br><span class="line">    <span class="string">&#x27;SLIDING_TOKEN_REFRESH_LIFETIME&#x27;</span>: timedelta(days=<span class="number">1</span>),</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>如果要覆盖Simple JWT的默认设置，可以修改<code>settings.py</code>, 如下所示。下例将refresh token的有效期改为了15天。</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> timedelta</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">SIMPLE_JWT = &#123;</span><br><span class="line">    <span class="string">&#x27;REFRESH_TOKEN_LIFETIME&#x27;</span>: timedelta(days=<span class="number">15</span>),</span><br><span class="line">    <span class="string">&#x27;ROTATE_REFRESH_TOKENS&#x27;</span>: <span class="literal">True</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>


<br>



<h3 id="自定义令牌"><a href="#自定义令牌" class="headerlink" title="自定义令牌"></a>自定义令牌</h3><p>如果你对Simple JWT返回的access token进行解码，你会发现这个token的payload数据部分包括token类型，token失效时间，jti(一个类似随机字符串）和user_id。如果你希望在payload部分提供更多信息，比如用户的username，这时你就要自定义令牌(token)了</p>
<p>首先，编写你的<code>myapp/seralizers.py</code>，添加如下代码。该序列化器继承了<code>TokenObtainPairSerializer</code>类</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework_simplejwt.serializers <span class="keyword">import</span> TokenObtainPairSerializer</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyTokenObtainPairSerializer</span>(<span class="title class_ inherited__">TokenObtainPairSerializer</span>):</span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_token</span>(<span class="params">cls, user</span>):</span><br><span class="line">        token = <span class="built_in">super</span>(MyTokenObtainPairSerializer, cls).get_token(user)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 添加额外信息</span></span><br><span class="line">        token[<span class="string">&#x27;username&#x27;</span>] = user.username</span><br><span class="line">        <span class="keyword">return</span> token</span><br></pre></td></tr></table></figure></div>

<p>其次，不使用Simple JWT提供的默认视图，使用自定义视图。修改 <code>myapp/views.py</code>, 添加如下代码：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework_simplejwt.views <span class="keyword">import</span> TokenObtainPairView</span><br><span class="line"><span class="keyword">from</span> rest_framework.permissions <span class="keyword">import</span> AllowAny</span><br><span class="line"><span class="keyword">from</span> .serializers <span class="keyword">import</span> MyTokenObtainPairSerializer</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyObtainTokenPairView</span>(<span class="title class_ inherited__">TokenObtainPairView</span>):</span><br><span class="line">    permission_classes = (AllowAny,)</span><br><span class="line">    serializer_class = MyTokenObtainPairSerializer</span><br></pre></td></tr></table></figure></div>

<p>最后，修改<code>apiproject/urls.py</code>, 添加如下代码，将&#x2F;token&#x2F;指向新的自定义的视图</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">path(<span class="string">&#x27;token/&#x27;</span>, MyObtainTokenPairView.as_view(), name=<span class="string">&#x27;token_obtain_pair&#x27;</span>),</span><br></pre></td></tr></table></figure></div>

<p>重新发送POST请求到&#x2F;token&#x2F;，你将获得新的access token和refresh token，对重新获取的access token进行解码，你将看到payload部分多了username的内容</p>
<br>




<h3 id="自定义认证后台"><a href="#自定义认证后台" class="headerlink" title="自定义认证后台"></a>自定义认证后台</h3><p>上面的演示案例是通过用户名和密码登录的，如果我们希望后台同时支持邮箱&#x2F;密码，手机&#x2F;密码组合登录怎么办? 这时我们还需要自定义认证后台</p>
<p>首先，修改<code>users/views.py</code>, 添加如下代码：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.contrib.auth.backends <span class="keyword">import</span> ModelBackend</span><br><span class="line"><span class="keyword">from</span> django.db.models <span class="keyword">import</span> Q</span><br><span class="line"><span class="keyword">from</span> django.contrib.auth <span class="keyword">import</span> get_user_model</span><br><span class="line"></span><br><span class="line">User = get_user_model()</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyCustomBackend</span>(<span class="title class_ inherited__">ModelBackend</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">authenticate</span>(<span class="params">self, request, username=<span class="literal">None</span>, password=<span class="literal">None</span>, **kwargs</span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            user = User.objects.get(Q(username=username) | Q(email=username) )</span><br><span class="line">            <span class="keyword">if</span> user.check_password(password):</span><br><span class="line">                <span class="keyword">return</span> user</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br></pre></td></tr></table></figure></div>

<p>其次，修改<code>settings.py</code>, 把你自定义的验证方式添加到AUTHENTICATION_BACKENDS里去。</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">AUTHENTICATION_BACKENDS = (</span><br><span class="line">    <span class="string">&#x27;users.views.MyCustomBackend&#x27;</span>,</span><br><span class="line">)</span><br></pre></td></tr></table></figure></div>

<p>修改好后，发送邮箱&#x2F;密码组合到&#x2F;token&#x2F;，将同样可以获得access token和refresh token</p>
<br>

<hr>
<br>



<h2 id="分页"><a href="#分页" class="headerlink" title="分页"></a>分页</h2><p>当你的数据库数据量非常大时，如果一次将这些数据查询出来, 必然加大了服务器内存的负载，降低系统的运行速度。一种更好的方式是将数据分段展示给用户。如果用户在展示的分段数据中没有找到自己的内容，可以通过指定页码或翻页的方式查看更多数据，直到找到自己想要的内容为止</p>
<br>


<h3 id="DRF提供的分页类"><a href="#DRF提供的分页类" class="headerlink" title="DRF提供的分页类"></a>DRF提供的分页类</h3><p>Django REST Framework提供了3种分页类</p>
<ul>
<li>PageNumberPagination：普通分页器。支持用户按?page&#x3D;3&amp;size&#x3D;10这种更灵活的方式进行查询，这样用户不仅可以选择页码，还可以选择每页展示数据的数量。通常还需要设置max_page_size这个参数限制每页展示数据的最大数量，以防止用户进行恶意查询(比如size&#x3D;10000), 这样一页展示1万条数据将使分页变得没有意义</li>
<li>LimitOffsetPagination：偏移分页器。支持用户按?limit&#x3D;20&amp;offset&#x3D;100这种方式进行查询。offset是查询数据的起始点，limit是每页展示数据的最大条数，类似于page_size。当你使用这个类时，你通常还需要设置max_limit这个参数来限制展示给用户数据的最大数量</li>
<li>CursorPagination类：加密分页器。这是DRF提供的加密分页查询，仅支持用户按响应提供的上一页和下一页链接进行分页查询，每页的页码都是加密的。使用这种方式进行分页需要你的模型有”created”这个字段，否则你要手动指定ordering排序才能进行使用</li>
</ul>
<h4 id="PageNumberPagination类"><a href="#PageNumberPagination类" class="headerlink" title="PageNumberPagination类"></a>PageNumberPagination类</h4><p>DRF中使用默认分页类的最简单方式就是在<code>settings.py</code>中进行全局配置，如下所示：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">REST_FRAMEWORK =&#123;</span><br><span class="line">    <span class="string">&#x27;DEFAULT_PAGINATION_CLASS&#x27;</span>: <span class="string">&#x27;rest_framework.pagination.PageNumberPagination&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;PAGE_SIZE&#x27;</span>: <span class="number">2</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>但是如果你希望用户按<code>?page=3&amp;size=10</code>这种更灵活的方式进行查询，你就要进行个性化定制。在实际开发过程中，定制比使用默认的分页类更常见，具体做法如下：</p>
<p>第一步：在app目录下新建<code>pagination.py</code>，添加如下代码：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.pagination <span class="keyword">import</span> PageNumberPagination</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyPageNumberPagination</span>(<span class="title class_ inherited__">PageNumberPagination</span>):</span><br><span class="line">    page_size = <span class="number">2</span>   				<span class="comment"># default page size</span></span><br><span class="line">    page_size_query_param = <span class="string">&#x27;size&#x27;</span>  <span class="comment"># ?page=xx&amp;size=??</span></span><br><span class="line">    max_page_size = <span class="number">10</span> 				<span class="comment"># max page size</span></span><br></pre></td></tr></table></figure></div>

<p>我们自定义了一个<code>MyPageNumberPagination</code>类，该类继承了<code>PageNumberPagination</code>类。我们通过<code>page_size</code>设置了每页默认展示数据的条数，通过<code>page_size_query_param</code>设置了每页size的参数名以及通过<code>max_page_size</code>设置了每个可以展示的最大数据条数。</p>
<p>第二步：使用自定义的分页类</p>
<p>在基于类的视图中，你可以使用<code>pagination_class</code>这个属性使用自定义的分页类，如下所示：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> .pagination <span class="keyword">import</span> MyPageNumberPagination</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ArticleList</span>(generics.ListCreateAPIView):</span><br><span class="line">    queryset = Article.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class = ArticleSerializer</span><br><span class="line">    permission_classes = (permissions.IsAuthenticatedOrReadOnly,)</span><br><span class="line">    pagination_class = MyPageNumberPagination</span><br><span class="line">	...</span><br></pre></td></tr></table></figure></div>

<p>当然定制分页类不限于指定<code>page_size</code>和<code>max_page_size</code>这些属性，你还可以改变响应数据的输出格式。比如我们这里希望把next和previous放在一个名为<code>links</code>的key里，我们可以修改<code>MyPageNumberPagination</code>类，重写<code>get_paginated_response</code>方法</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.pagination <span class="keyword">import</span> PageNumberPagination</span><br><span class="line"><span class="keyword">from</span> rest_framework.response <span class="keyword">import</span> Response</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyPageNumberPagination</span>(<span class="title class_ inherited__">PageNumberPagination</span>):</span><br><span class="line">    page_size = <span class="number">2</span>   <span class="comment"># default page size</span></span><br><span class="line">    page_size_query_param = <span class="string">&#x27;size&#x27;</span>  <span class="comment"># ?page=xx&amp;size=??</span></span><br><span class="line">    max_page_size = <span class="number">10</span> <span class="comment"># max page size</span></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_paginated_response</span>(<span class="params">self, data</span>):</span><br><span class="line">        <span class="keyword">return</span> Response(&#123;</span><br><span class="line">            <span class="string">&#x27;links&#x27;</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;next&#x27;</span>: <span class="variable language_">self</span>.get_next_link(),</span><br><span class="line">                <span class="string">&#x27;previous&#x27;</span>: <span class="variable language_">self</span>.get_previous_link()</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&#x27;count&#x27;</span>: <span class="variable language_">self</span>.page.paginator.count,</span><br><span class="line">            <span class="string">&#x27;results&#x27;</span>: data</span><br><span class="line">        &#125;)</span><br></pre></td></tr></table></figure></div>

<p>注意：重写<code>get_paginated_response</code>方法非常有用，你还可以给分页响应数据传递额外的内容，比如code状态码等等</p>
<p>前面的例子中我们只在单个基于类的视图或视图集中使用到了分页类，你还可以修改<code>settings.py</code>全局使用你自定义的分页类，如下所示。展示效果是一样的，我们就不详细演示了。</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">REST_FRAMEWORK = &#123;</span><br><span class="line">    <span class="string">&#x27;DEFAULT_PAGINATION_CLASS&#x27;</span>: <span class="string">&#x27;blog.pagination.MyPageNumberPagination&#x27;</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>



<h4 id="LimitOffsetPagination类"><a href="#LimitOffsetPagination类" class="headerlink" title="LimitOffsetPagination类"></a>LimitOffsetPagination类</h4><p>使用这个分页类最简单的方式就是在<code>settings.py</code>中进行全局配置，如下所示：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">REST_FRAMEWORK = &#123;</span><br><span class="line">    <span class="string">&#x27;DEFAULT_PAGINATION_CLASS&#x27;</span>: <span class="string">&#x27;rest_framework.pagination.LimitOffsetPagination&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>你也可以自定义<code>MyLimitOffsetPagination</code>类，在单个视图或视图集中使用，或者全局使用</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.pagination <span class="keyword">import</span> LimitOffsetPagination</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyLimitOffsetPagination</span>(<span class="title class_ inherited__">LimitOffsetPagination</span>):</span><br><span class="line">    default_limit = <span class="number">5</span>   <span class="comment"># default limit per age</span></span><br><span class="line">    limit_query_param = <span class="string">&#x27;limit&#x27;</span>  <span class="comment"># default is limit</span></span><br><span class="line">    offset_query_param = <span class="string">&#x27;offset&#x27;</span>  <span class="comment"># default param is offset</span></span><br><span class="line">    max_limit = <span class="number">10</span> <span class="comment"># max limit per age</span></span><br></pre></td></tr></table></figure></div>



<h4 id="CursorPagination类"><a href="#CursorPagination类" class="headerlink" title="CursorPagination类"></a>CursorPagination类</h4><p>使用这个分页类最简单的方式同样是在<code>settings.py</code>中进行全局配置</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">REST_FRAMEWORK = &#123;</span><br><span class="line">    <span class="string">&#x27;DEFAULT_PAGINATION_CLASS&#x27;</span>: <span class="string">&#x27;rest_framework.pagination.CursorPagination&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;PAGE_SIZE&#x27;</span>: <span class="number">2</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>如果出现错误，是因为使用<code>CursorPagination</code>类需要你的模型里有<code>created</code>这个字段，否则你需要手动指定<code>ordering</code>字段。这是因为<code>CursorPagination</code>类只能对排过序的查询集进行分页展示。我们的Article模型只有<code>create_dat</code>e字段，没有created这个字段，所以会报错</p>
<p>为了解决这个问题，我们需要自定义一个<code>MyCursorPagination</code>类，手动指定按<code>create_date</code>排序, 如下所示：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.pagination <span class="keyword">import</span> CursorPagination</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyArticleCursorPagination</span>(<span class="title class_ inherited__">CursorPagination</span>):</span><br><span class="line">    page_size = <span class="number">3</span> <span class="comment"># Default number of records per age</span></span><br><span class="line">    page_size_query_param = <span class="string">&#x27;page_size&#x27;</span> </span><br><span class="line">    cursor_query_param = <span class="string">&#x27;cursor&#x27;</span> <span class="comment"># Default is cursor</span></span><br><span class="line">    ordering = <span class="string">&#x27;-create_date&#x27;</span></span><br></pre></td></tr></table></figure></div>

<p>修改<code>settings.py</code>, 使用自己定义的分页类</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">REST_FRAMEWORK = &#123;</span><br><span class="line">    <span class="string">&#x27;DEFAULT_PAGINATION_CLASS&#x27;</span>: <span class="string">&#x27;blog.pagination.MyArticleCursorPagination&#x27;</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>结果中你将得到previous和next分页链接。页码都加密了, 链接里不再显示页码号码。默认每页展示3条记录, 如果使用?page_size&#x3D;2进行查询，每页你将得到两条记录</p>
<p>当然由于这个<code>ordering</code>字段与模型相关，我们并不推荐全局使用自定义的CursorPagination类，更好的方式是在视图的<code>pagination_class</code>属性指定</p>
<h4 id="函数类视图中使用分页类"><a href="#函数类视图中使用分页类" class="headerlink" title="函数类视图中使用分页类"></a>函数类视图中使用分页类</h4><p>注意<code>pagination_class</code>属性仅支持在<code>genericsAPIView</code>和视图集viewset中配置使用。如果你使用函数或简单的APIView开发API视图，那么你需要对你的数据进行手动分页，一个具体使用例子如下所示：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.pagination <span class="keyword">import</span> PageNumberPagination</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ArticleList0</span>(<span class="title class_ inherited__">APIView</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    List all articles, or create a new article.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get</span>(<span class="params">self, request, <span class="built_in">format</span>=<span class="literal">None</span></span>):</span><br><span class="line">        articles = Article.objects.<span class="built_in">all</span>()</span><br><span class="line">        </span><br><span class="line">        page = PageNumberPagination()  <span class="comment"># 产生一个分页器对象</span></span><br><span class="line">        page.page_size = <span class="number">3</span>  <span class="comment"># 默认每页显示的多少条记录</span></span><br><span class="line">        page.page_query_param = <span class="string">&#x27;page&#x27;</span>  <span class="comment"># 默认查询参数名为 page</span></span><br><span class="line">        page.page_size_query_param = <span class="string">&#x27;size&#x27;</span>  <span class="comment"># 前台控制每页显示的最大条数</span></span><br><span class="line">        page.max_page_size = <span class="number">10</span>  <span class="comment"># 后台控制显示的最大记录条数</span></span><br><span class="line">        </span><br><span class="line">        ret = page.paginate_queryset(articles, request)</span><br><span class="line">        serializer = ArticleSerializer(ret, many=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">return</span> Response(serializer.data)</span><br></pre></td></tr></table></figure></div>

<h4 id=""><a href="#" class="headerlink" title=""></a></h4><br>

<hr>
<br>


<h2 id="过滤与排序"><a href="#过滤与排序" class="headerlink" title="过滤与排序"></a>过滤与排序</h2><p>本节将演示三种过滤方法, 你可以根据实际项目开发需求去使用</p>
<br>


<h3 id="重写get-queryset方法"><a href="#重写get-queryset方法" class="headerlink" title="重写get_queryset方法"></a>重写get_queryset方法</h3><p>此方法不依赖于任何第三方包, 只适合于需要过滤的字段比较少的模型。比如这里我们希望对文章title进行过滤，我们只需要修改ArticleList视图函数类即可</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> generics</span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> permissions</span><br><span class="line"><span class="keyword">from</span> .permissions <span class="keyword">import</span> IsOwnerOrReadOnly</span><br><span class="line"><span class="keyword">from</span> .pagination <span class="keyword">import</span> MyPageNumberPagination</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ArticleList</span>(generics.ListCreateAPIView):</span><br><span class="line">    serializer_class = ArticleSerializer</span><br><span class="line">    permission_classes = (permissions.IsAuthenticatedOrReadOnly,)</span><br><span class="line">    pagination_class = MyPageNumberPagination</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_queryset</span>(<span class="params">self</span>):</span><br><span class="line">        keyword = <span class="variable language_">self</span>.request.query_params.get(<span class="string">&#x27;q&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> keyword:</span><br><span class="line">            queryset = Article.objects.<span class="built_in">all</span>()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            queryset = Article.objects.<span class="built_in">filter</span>(title__icontains=keyword)</span><br><span class="line">        <span class="keyword">return</span> queryset</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure></div>

<p>修改好视图类后，发送GET请求到&#x2F;v1&#x2F;articles?page&#x3D;1&amp;q&#x3D;django, 你将得到所有标题含有django关键词的文章列表</p>
<p><strong>注意</strong>：DRF中你通过<code>request.query_params</code>获取GET请求发过来的参数，而不是request.GET。如果你希望获取从URL里传递的参数，你可以使用<code>self.kwargs[&#39;param1&#39;]</code>。二者的区别在于<code>query_params</code>用于URL中的查询字符串参数，即问号后的内容，而<code>self.kwargs[&#39;param1&#39;]</code>用于获取URL路径中通过正则表达式捕获的参数</p>
<p>假如你的URL配置如下所示：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">re_path(<span class="string">&#x27;^articles/(?P&lt;username&gt;.+)/$&#x27;</span>, AricleList.as_view()),</span><br></pre></td></tr></table></figure></div>

<p>在视图中你可以通过<code>self.kwargs[&#39;username&#39;]</code>获取URL传递过来的用户名。</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ArticleList</span>(generics.ListAPIView):</span><br><span class="line">    serializer_class = ArticleSerializer</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_queryset</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        按用户名查询发表文章清单</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        username = <span class="variable language_">self</span>.kwargs[<span class="string">&#x27;username&#x27;</span>]</span><br><span class="line">        <span class="keyword">return</span> Article.objects.<span class="built_in">filter</span>(author__username=username)</span><br></pre></td></tr></table></figure></div>


<br>



<h3 id="使用django-filter"><a href="#使用django-filter" class="headerlink" title="使用django-filter"></a>使用django-filter</h3><p>当一个模型需要过滤的字段很多且不确定时(比如文章状态、正文等等), 重写get_queryset方法将变得非常麻烦，更好的方式是借助django-filter这个第三方库实现过滤</p>
<p><code>django-filter</code>库包含一个<code>DjangoFilterBackend</code>类，该类支持REST框架的高度可定制的字段过滤。这是最推荐的过滤方法, 因为它自定义需要过滤的字段非常方便, 还可以对每个字段指定过滤方法(比如模糊查询和精确查询)</p>
<h4 id="安装django-filter"><a href="#安装django-filter" class="headerlink" title="安装django-filter"></a>安装django-filter</h4><div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install django-filter</span><br></pre></td></tr></table></figure></div>

<p>把<code>django_filters</code>添加到INSTALLED_APPS中去。</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">INSTALLED_APPS = [</span><br><span class="line">    ...,</span><br><span class="line">    django_filters,</span><br><span class="line">]</span><br></pre></td></tr></table></figure></div>

<p>接下来你还需要把<code>DjangoFilterBackend</code>设为过滤后台。你可以在<code>settings.py</code>中进行全局配置。</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">REST_FRAMEWORK = &#123;</span><br><span class="line">    <span class="string">&#x27;DEFAULT_FILTER_BACKENDS&#x27;</span>: [<span class="string">&#x27;django_filters.rest_framework.DjangoFilterBackend&#x27;</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>还可以在单个视图中使用它，在类视图中使用django-filter时，你可以直接通过<code>filterset_fields</code>设置希望过滤的字段，如下所示：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django_filters <span class="keyword">import</span> rest_framework</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ArticleList</span>(generics.ListCreateAPIView):</span><br><span class="line">    </span><br><span class="line">    filter_backends = (rest_framework.DjangoFilterBackend,)</span><br><span class="line">    filterset_fields = [<span class="string">&#x27;title&#x27;</span>, <span class="string">&#x27;status&#x27;</span>]</span><br></pre></td></tr></table></figure></div>

<p>如果你希望进行更多定制化的行为，你需要自定义FilterSet类，然后指定<code>filter_class</code></p>
<h4 id="自定义FilterSet类"><a href="#自定义FilterSet类" class="headerlink" title="自定义FilterSet类"></a>自定义FilterSet类</h4><p>新建<code>blog/filters.py</code>, 添加如下代码：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> django_filters</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Article</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ArticleFilter</span>(django_filters.FilterSet):</span><br><span class="line">    q = django_filters.CharFilter(field_name=<span class="string">&#x27;title&#x27;</span>, lookup_expr=<span class="string">&#x27;icontains&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Meta</span>:</span><br><span class="line">        model = Article</span><br><span class="line">        fields = (<span class="string">&#x27;title&#x27;</span>, <span class="string">&#x27;status&#x27;</span>)</span><br></pre></td></tr></table></figure></div>

<p>接下来通过<code>filter_class</code>使用它</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django_filters <span class="keyword">import</span> rest_framework</span><br><span class="line"><span class="keyword">from</span> .filters <span class="keyword">import</span> ArticleFilter</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ArticleList</span>(generics.ListCreateAPIView):</span><br><span class="line">    queryset = Article.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class = ArticleSerializer</span><br><span class="line">    permission_classes = (permissions.IsAuthenticatedOrReadOnly,)</span><br><span class="line">    pagination_class = MyPageNumberPagination</span><br><span class="line"></span><br><span class="line">    filter_backends = (rest_framework.DjangoFilterBackend,)</span><br><span class="line">    filter_class = ArticleFilter</span><br></pre></td></tr></table></figure></div>

<p>发送GET请求到&#x2F;v1&#x2F;articles?page&#x3D;2&amp;q&#x3D;django&amp;status&#x3D;p, 你将得到只包含发表了的文章</p>
<p>你还可以看到REST框架API测试部分提供了一个新的Filters下拉菜单按钮，可以帮助您对结果进行过滤</p>
<br>


<h3 id="方法三-使用SearchFilter类"><a href="#方法三-使用SearchFilter类" class="headerlink" title="方法三: 使用SearchFilter类"></a>方法三: 使用SearchFilter类</h3><p>其实DRF自带了具有过滤功能的<code>SearchFilter</code>类，其使用场景与<code>Django-filter</code>的单字段过滤略有不同，更侧重于使用一个关键词对模型的某个字段或多个字段同时进行搜索</p>
<p>使用这个类，你还需要指定<code>search_fields</code>, 具体使用方式如下：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> filters</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ArticleList</span>(generics.ListCreateAPIView):</span><br><span class="line">    queryset = Article.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class = ArticleSerializer</span><br><span class="line">    permission_classes = (permissions.IsAuthenticatedOrReadOnly,)</span><br><span class="line">    pagination_class = MyPageNumberPagination</span><br><span class="line"></span><br><span class="line">    filter_backends = (filters.SearchFilter, )</span><br><span class="line">    search_fields = (<span class="string">&#x27;title&#x27;</span>,)</span><br></pre></td></tr></table></figure></div>

<p>可发送GET请求到&#x2F;v1&#x2F;articles?page&#x3D;1&amp;search&#x3D;django测试</p>
<p><strong>注意</strong>：这里进行搜索查询的默认参数名为?search&#x3D;xxx</p>
<p>SearchFilter类非常有用，因为它不仅支持对模型的多个字段进行查询，还支持ForeinKey和ManyToMany字段的关联查询。按如下修改<code>search_fields</code>, 就可以同时搜索标题或用户名含有某个关键词的文章资源列表。修改好后，作者用户名里如果有django，该篇文章也会包含在搜索结果了</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">search_fields = (&#x27;title&#x27;, &#x27;author__username&#x27;)</span><br></pre></td></tr></table></figure></div>

<p>默认情况下，SearchFilter类搜索将使用不区分大小写的部分匹配(icontains)。你可以在search_fields中添加各种字符来指定匹配方法。</p>
<ul>
<li>’^’开始-搜索</li>
<li>’&#x3D;’完全匹配</li>
<li>’@’全文搜索</li>
<li>’$’正则表达式搜索</li>
</ul>
<p>例如：search_fields &#x3D; (‘&#x3D;title’, )精确匹配title</p>
<h4 id="自定义SearchFilter类"><a href="#自定义SearchFilter类" class="headerlink" title="自定义SearchFilter类"></a>自定义SearchFilter类</h4><p>默认SearchFilter类仅支持<code>?search=xxx</code>这个传递参数，你可以通过设置<code>SEARCH_PARAM</code>覆盖。另外你还可以重写<code>get_search_fileds</code>方法改变它的行为。下例中，当你按照&#x2F;?search&#x3D;keyword&amp;title_only&#x3D;True提交请求时，它将只针对title进行查询。</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> filters</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CustomSearchFilter</span>(filters.SearchFilter):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_search_fields</span>(<span class="params">self, view, request</span>):</span><br><span class="line">        <span class="keyword">if</span> request.query_params.get(<span class="string">&#x27;title_only&#x27;</span>):</span><br><span class="line">            <span class="keyword">return</span> [<span class="string">&#x27;title&#x27;</span>]</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>(CustomSearchFilter, <span class="variable language_">self</span>).get_search_fields(view, request)</span><br></pre></td></tr></table></figure></div>

<br>




<h3 id="排序OrderingFilter类"><a href="#排序OrderingFilter类" class="headerlink" title="排序OrderingFilter类"></a>排序OrderingFilter类</h3><p>使用<code>OrderingFilter</code>类首先要把它加入到<code>filter_backends</code>， 然后指定排序字段即可，如下所示：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> filters</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ArticleList</span>(generics.ListCreateAPIView):</span><br><span class="line">    queryset = Article.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class = ArticleSerializer</span><br><span class="line">    permission_classes = (permissions.IsAuthenticatedOrReadOnly,)</span><br><span class="line">    pagination_class = MyPageNumberPagination</span><br><span class="line"></span><br><span class="line">    filter_backends = (filters.SearchFilter, filters.OrderingFilter,)</span><br><span class="line">    search_fields = (<span class="string">&#x27;title&#x27;</span>,)</span><br><span class="line">    ordering_fields = (<span class="string">&#x27;create_date&#x27;</span>)</span><br></pre></td></tr></table></figure></div>

<p>发送请求时只需要在参数上加上<code>?ordering=create_date</code>或者<code>?ordering=-create_date</code>即可实现对结果按文章创建时间正序和逆序进行排序</p>
<p><strong>注意</strong>：实际开发应用中OrderingFilter类，SearchFilter类和DjangoFilterBackend经常一起联用作为DRF的<code>filter_backends</code>，没有相互冲突</p>
<br>


<hr>
<br>


<h2 id="限流"><a href="#限流" class="headerlink" title="限流"></a>限流</h2><h3 id="限流概念"><a href="#限流概念" class="headerlink" title="限流概念"></a>限流概念</h3><p>限流(Throttle)就是限制客户端对API 的调用频率，是API开发者必须要考虑的因素。比如个别客户端(比如爬虫程序)短时间发起大量请求，超过了服务器能够处理的能力，将会影响其它用户的正常使用。又或者某个接口占用数据库资源比较多，如果同一时间该接口被大量调用，服务器可能会陷入僵死状态。为了保证API服务的稳定性，并防止接口受到恶意用户的攻击，我们必须要对我们的API服务进行限流</p>
<p>DRF中限制对API的调用频率非常简便，它为我们主要提供了3个可插拔使用的限流类：</p>
<ul>
<li><code>AnonRateThrottle</code>用于限制未认证用户的请求频率，主要根据用户的 IP地址来确定用户身份。</li>
<li><code>UserRateThrottle</code>用于限定认证用户的请求频率，可对不同类型的用户实施不同的限流政策。</li>
<li><code>ScopeRateThrottle</code>可用于限制对 API 特定部分的访问。只有当正在访问的视图包含 <code>throttle_scope</code>属性时才会应用此限制。这个与UserRateThrottle类的区别在于一个针对用户限流，一个针对API接口限流。</li>
</ul>
<p>DRF限制频率的指定格式为 “最大访问次数&#x2F;时间间隔”，例如设置为 5&#x2F;min，则只允许一分钟内最多调用接口 5 次。其它常用格式包括”10&#x2F;s”, “100&#x2F;d”等。超过限定次数的调用将抛出 <code>exceptions.Throttled</code>异常，客户端收到 429 状态码（too many requests）的响应。</p>
<br>



<h3 id="全局使用限流类"><a href="#全局使用限流类" class="headerlink" title="全局使用限流类"></a>全局使用限流类</h3><p>现在我们尝试对<code>/v1/articles/</code>这个接口增加限流，匿名用户请求频率限制在2&#x2F;min，而认证用户请求频率限制在10&#x2F;min</p>
<p>最简单的使用DRF自带限流类的方法，就是在<code>settings.py</code>中进行全局配置，一是要设置需要使用的限流类，二是要设置限流范围(scope)及其限流频率。<code>AnonRateThrottle</code>和<code>UserRateThrottle</code>默认的scope分别为”anon”和”user”。该配置会对所有API接口生效</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">REST_FRAMEWORK = &#123;</span><br><span class="line">    <span class="string">&#x27;DEFAULT_THROTTLE_CLASSES&#x27;</span>: [</span><br><span class="line">        <span class="string">&#x27;rest_framework.throttling.AnonRateThrottle&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;rest_framework.throttling.UserRateThrottle&#x27;</span>,</span><br><span class="line"></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&#x27;DEFAULT_THROTTLE_RATES&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;anon&#x27;</span>: <span class="string">&#x27;2/min&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;user&#x27;</span>: <span class="string">&#x27;10/min&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>


<br>



<h3 id="视图类或视图集中使用限流类"><a href="#视图类或视图集中使用限流类" class="headerlink" title="视图类或视图集中使用限流类"></a>视图类或视图集中使用限流类</h3><p>DRF中还可以在单个视图或单个视图集中进行限流配置，单个视图中的配置会覆盖全局设置。现在我们希望保留<code>settings.py</code>的限流全局配置，并专门为文章资源列表&#x2F;v1&#x2F;articles定制一个限流类，新的访问频率限制为匿名用户为5&#x2F;min，认证用户为30&#x2F;min，该配置仅对文章资源列表这个接口生效</p>
<p>我们首先在app文件夹blog目录下新建<code>throttles.py</code>， 添加如下代码：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.throttling <span class="keyword">import</span> AnonRateThrottle, UserRateThrottle</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ArticleListAnonRateThrottle</span>(<span class="title class_ inherited__">AnonRateThrottle</span>):</span><br><span class="line">    THROTTLE_RATES = &#123;<span class="string">&quot;anon&quot;</span>: <span class="string">&quot;5/min&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ArticleListUserRateThrottle</span>(<span class="title class_ inherited__">UserRateThrottle</span>):</span><br><span class="line">    THROTTLE_RATES = &#123;<span class="string">&quot;user&quot;</span>: <span class="string">&quot;30/min&quot;</span>&#125;</span><br></pre></td></tr></table></figure></div>

<p>我们通过继承自定义了<code>ArticleListAnonRateThrottle</code>, <code>ArticleListUserRateThrottle</code>两个类，并通过THROTTLE_RATES属性设置了新的访问频率限制。现在我们可以将它们应用到views.py中对应文章资源列表的API视图类</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> .throttles <span class="keyword">import</span> ArticleListAnonRateThrottle, ArticleListUserRateThrottle</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ArticleList</span>(generics.ListCreateAPIView):</span><br><span class="line">    queryset = Article.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class = ArticleSerializer</span><br><span class="line">    permission_classes = (permissions.IsAuthenticatedOrReadOnly,)</span><br><span class="line">    pagination_class = MyPageNumberPagination</span><br><span class="line">    throttle_classes = [ArticleListAnonRateThrottle, ArticleListUserRateThrottle]</span><br></pre></td></tr></table></figure></div>

<p>有时对一个认证用户进行限流不仅要限制每分钟的请求次数，还需要限制每小时的请求次数，我们可以自定义两个<code>UserRateThrottle</code>子类，并设置不同的scope，如下所示：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.throttling <span class="keyword">import</span> AnonRateThrottle, UserRateThrottle</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MinuteUserRateThrottle</span>(<span class="title class_ inherited__">UserRateThrottle</span>):</span><br><span class="line">    scope = <span class="string">&#x27;limit_per_minute&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HourUserRateThrottle</span>(<span class="title class_ inherited__">UserRateThrottle</span>):</span><br><span class="line">    scope = <span class="string">&#x27;limit_per_hour&#x27;</span></span><br></pre></td></tr></table></figure></div>

<p>然后修改我们的视图类，使用新的限流类：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">throttle_classes = [HourUserRateThrottle, MinuteUserRateThrottle]</span><br></pre></td></tr></table></figure></div>

<p>现在我们只指定了限流类，还未设置限流频率，可以去settings.py中设置，也可以在自定义限流类中通过<code>THROTTLE_RATES</code>属性指定。</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">REST_FRAMEWORK = &#123;</span><br><span class="line">    <span class="string">&#x27;DEFAULT_THROTTLE_CLASSES&#x27;</span>: [</span><br><span class="line">        <span class="string">&#x27;rest_framework.throttling.AnonRateThrottle&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;rest_framework.throttling.UserRateThrottle&#x27;</span>,</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&#x27;DEFAULT_THROTTLE_RATES&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;anon&#x27;</span>: <span class="string">&#x27;2/min&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;user&#x27;</span>: <span class="string">&#x27;10/min&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;limit_per_minute&#x27;</span>:<span class="string">&#x27;5/min&#x27;</span>, <span class="comment"># 新增</span></span><br><span class="line">        <span class="string">&#x27;limit_per_hour&#x27;</span>: <span class="string">&#x27;500/hour&#x27;</span>, <span class="comment"># 新增</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<br>




<h3 id="ScopeRateThrottle类"><a href="#ScopeRateThrottle类" class="headerlink" title="ScopeRateThrottle类"></a>ScopeRateThrottle类</h3><p><code>AnonRateThrottle</code>和<code>UserRateThrottle</code>类都是针对单个用户请求进行限流的，而<code>ScopeRateThrottle</code>类是针对不同API接口资源进行限流的，限制的是所有用户对接口的访问总数之和。使用时直接在视图类里通过<code>throttle_scope</code> 属性指定限流范围(scope), 然后在settings.py对不同scope设置限流频率。例子如下所示：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ArticleListView</span>(<span class="title class_ inherited__">APIView</span>):</span><br><span class="line">    throttle_scope = <span class="string">&#x27;article_list&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ArticleDetailView</span>(<span class="title class_ inherited__">APIView</span>):    </span><br><span class="line">    throttle_scope = <span class="string">&#x27;article_detail&#x27;</span></span><br></pre></td></tr></table></figure></div>

<p>针对不同api接口设置不同限流频率。如下配置代表文章资源列表一天限1000次请求(所有用户访问数量之和)，文章详情接口限1小时100次。</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">REST_FRAMEWORK = &#123;</span><br><span class="line">    <span class="string">&#x27;DEFAULT_THROTTLE_CLASSES&#x27;</span>: [</span><br><span class="line">        <span class="string">&#x27;rest_framework.throttling.AnonRateThrottle&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;rest_framework.throttling.UserRateThrottle&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;rest_framework.throttling.ScopedRateThrottle&#x27;</span>,</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&#x27;DEFAULT_THROTTLE_RATES&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;anon&#x27;</span>: <span class="string">&#x27;2/min&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;user&#x27;</span>: <span class="string">&#x27;10/min&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;article_list&#x27;</span>:<span class="string">&#x27;1000/day&#x27;</span>, 		<span class="comment"># 新增</span></span><br><span class="line">        <span class="string">&#x27;article_detail&#x27;</span>: <span class="string">&#x27;100/hour&#x27;</span>, 	<span class="comment"># 新增</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>


<br>



<h3 id="自定义限流类"><a href="#自定义限流类" class="headerlink" title="自定义限流类"></a>自定义限流类</h3><p>有时你还需要自定义限流类。这时你需要继承BaseThrottle类、SimpleRateThrottle或者UserRateThrottle类，然后重写<code>allow_request(self, request, view)</code>或者<code>get_rate(self, request=none)</code>方法。DRF给的示例方法如下所示，该限流类10个请求中只允许一个通过。</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RandomRateThrottle</span>(throttling.BaseThrottle):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">allow_request</span>(<span class="params">self, request, view</span>):</span><br><span class="line">        <span class="keyword">return</span> random.randint(<span class="number">1</span>, <span class="number">10</span>) != <span class="number">1</span></span><br></pre></td></tr></table></figure></div>
        </div>

        
            <div class="post-copyright-info w-full my-8 px-2 sm:px-6 md:px-8">
                <div class="article-copyright-info-container">
    <ul>
        <li><strong>标题:</strong> Django之DRF</li>
        <li><strong>作者:</strong> rainbowYao</li>
        <li><strong>创建于
                :</strong> 2024-08-21 23:56:36</li>
        
            <li>
                <strong>更新于
                    :</strong> 2024-09-18 09:21:54
            </li>
        
        <li>
            <strong>链接:</strong> https://redefine.ohevan.com/2024/08/21/Django之DRF/
        </li>
        <li>
            <strong>
                版权声明:
            </strong>
            

            
                本文章采用 <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0">CC BY-NC-SA 4.0</a> 进行许可。
            
        </li>
    </ul>
</div>

            </div>
        

        
            <ul class="post-tags-box text-lg mt-1.5 flex-wrap justify-center flex md:hidden">
                
                    <li class="tag-item mx-0.5">
                        <a href="/tags/Django/">#Django</a>&nbsp;
                    </li>
                
                    <li class="tag-item mx-0.5">
                        <a href="/tags/DRF/">#DRF</a>&nbsp;
                    </li>
                
            </ul>
        

        
  <div class="recommended-article px-2 sm:px-6 md:px-8">
   <div class="recommended-desktop">
    <div class="recommended-article-header text-xl md:text-3xl font-bold mt-10">
     <i aria-hidden="true"></i><span>推荐阅读</span>
    </div>
    <div class="recommended-article-group"><a class="recommended-article-item" href="/2024/08/23/Django之信号量/" title="Django之信号量" rel="bookmark">
  <img src="https://blog-yyb.oss-cn-beijing.aliyuncs.com/thumbnail/thumbnail17.jpg" alt="Django之信号量" class="!max-w-none">
  <span class="title">Django之信号量</span>
</a><a class="recommended-article-item" href="/2024/08/17/Django之ORM/" title="Django之ORM" rel="bookmark">
  <img src="https://blog-yyb.oss-cn-beijing.aliyuncs.com/thumbnail/thumbnail13.jpg" alt="Django之ORM" class="!max-w-none">
  <span class="title">Django之ORM</span>
</a><a class="recommended-article-item" href="/2024/07/01/前端笔记-HTML/" title="前端笔记 HTML" rel="bookmark">
  <img src="https://blog-yyb.oss-cn-beijing.aliyuncs.com/thumbnail/thumbnail8.jpg" alt="前端笔记 HTML" class="!max-w-none">
  <span class="title">前端笔记 HTML</span>
</a></div>
   </div>
   <div class="recommended-mobile">
   <div class="recommended-article-header text-xl md:text-3xl font-bold mt-10">
     <i aria-hidden="true"></i><span>推荐阅读</span>
   </div>
   <div class="recommended-article-group"><a class="recommended-article-item" href="/2024/08/23/Django之信号量/" title="Django之信号量" rel="bookmark">
  <img src="https://blog-yyb.oss-cn-beijing.aliyuncs.com/thumbnail/thumbnail17.jpg" alt="Django之信号量" class="!max-w-none">
  <span class="title">Django之信号量</span>
</a><a class="recommended-article-item" href="/2024/08/17/Django之ORM/" title="Django之ORM" rel="bookmark">
  <img src="https://blog-yyb.oss-cn-beijing.aliyuncs.com/thumbnail/thumbnail13.jpg" alt="Django之ORM" class="!max-w-none">
  <span class="title">Django之ORM</span>
</a></div>
   </div>
  </div>

        
            <div class="article-nav my-8 flex justify-between items-center px-2 sm:px-6 md:px-8">
                
                    <div class="article-prev border-border-color shadow-redefine-flat shadow-shadow-color-2 rounded-medium px-4 py-2 hover:shadow-redefine-flat-hover hover:shadow-shadow-color-2">
                        <a class="prev"
                        rel="prev"
                        href="/2024/08/23/Django%E4%B9%8B%E4%BF%A1%E5%8F%B7%E9%87%8F/"
                        >
                            <span class="left arrow-icon flex justify-center items-center">
                                <i class="fa-solid fa-chevron-left"></i>
                            </span>
                            <span class="title flex justify-center items-center">
                                <span class="post-nav-title-item">Django之信号量</span>
                                <span class="post-nav-item">上一篇</span>
                            </span>
                        </a>
                    </div>
                
                
                    <div class="article-next border-border-color shadow-redefine-flat shadow-shadow-color-2 rounded-medium px-4 py-2 hover:shadow-redefine-flat-hover hover:shadow-shadow-color-2">
                        <a class="next"
                        rel="next"
                        href="/2024/08/17/Django%E4%B9%8BORM/"
                        >
                            <span class="title flex justify-center items-center">
                                <span class="post-nav-title-item">Django之ORM</span>
                                <span class="post-nav-item">下一篇</span>
                            </span>
                            <span class="right arrow-icon flex justify-center items-center">
                                <i class="fa-solid fa-chevron-right"></i>
                            </span>
                        </a>
                    </div>
                
            </div>
        


        
    </div>

    
        <div class="toc-content-container">
            <div class="post-toc-wrap">
    <div class="post-toc">
        <div class="toc-title">此页目录</div>
        <div class="page-title">Django之DRF</div>
        <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86"><span class="nav-text">前置知识</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#DRF%E5%AE%89%E8%A3%85"><span class="nav-text">DRF安装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BA%8F%E5%88%97%E5%8C%96%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86"><span class="nav-text">序列化基础知识</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AC%A6%E5%90%88RESTful%E8%A7%84%E8%8C%83%E7%9A%84API"><span class="nav-text">符合RESTful规范的API</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%A4%BA%E4%BE%8B%E5%BC%95%E5%85%A5%E5%BA%8F%E5%88%97%E5%8C%96%E5%99%A8%E4%B8%8E%E5%87%BD%E6%95%B0%E8%A7%86%E5%9B%BE%EF%BC%88FBV%EF%BC%89"><span class="nav-text">示例引入序列化器与函数视图（FBV）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C"><span class="nav-text">准备工作</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E5%BA%8F%E5%88%97%E5%8C%96%E5%99%A8"><span class="nav-text">自定义序列化器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%96%E5%86%99API%E8%A7%86%E5%9B%BE"><span class="nav-text">编写API视图</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%99URLs%E6%B7%BB%E5%8A%A0%E5%8F%AF%E9%80%89%E7%9A%84%E6%A0%BC%E5%BC%8F%E5%90%8E%E7%BC%80"><span class="nav-text">给URLs添加可选的格式后缀</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#API%E6%B5%8B%E8%AF%95"><span class="nav-text">API测试</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E4%BA%8E%E7%B1%BB%E7%9A%84%E8%A7%86%E5%9B%BE%E5%92%8C%E8%A7%86%E5%9B%BE%E9%9B%86"><span class="nav-text">基于类的视图和视图集</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E5%9F%BA%E7%A1%80APIView%E7%B1%BB"><span class="nav-text">使用基础APIView类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%94%A8Mixin%E7%B1%BB%E5%92%8CGenericAPI%E7%B1%BB%E6%B7%B7%E9%85%8D"><span class="nav-text">用Mixin类和GenericAPI类混配</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E9%80%9A%E7%94%A8%E8%A7%86%E5%9B%BEGenerics-%E7%B1%BB"><span class="nav-text">使用通用视图Generics.*类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E8%A7%86%E5%9B%BE%E9%9B%86ViewSet"><span class="nav-text">使用视图集ViewSet</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-text">总结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BA%8F%E5%88%97%E5%8C%96%E5%99%A8%E8%BF%9B%E9%98%B6"><span class="nav-text">序列化器进阶</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%94%B9%E5%8F%98%E5%BA%8F%E5%88%97%E5%8C%96%E5%99%A8%E7%9A%84%E8%BE%93%E5%87%BA"><span class="nav-text">改变序列化器的输出</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B3%E7%B3%BB%E5%BA%8F%E5%88%97%E5%8C%96"><span class="nav-text">关系序列化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E9%AA%8C%E8%AF%81%EF%BC%88Validation%EF%BC%89"><span class="nav-text">数据验证（Validation）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%87%8D%E5%86%99%E5%BA%8F%E5%88%97%E5%8C%96%E5%99%A8%E7%9A%84create%E5%92%8Cupdate%E6%96%B9%E6%B3%95"><span class="nav-text">重写序列化器的create和update方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD%E5%BA%8F%E5%88%97%E5%8C%96%E5%99%A8"><span class="nav-text">动态加载序列化器</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AE%A4%E8%AF%81%E4%B8%8E%E6%9D%83%E9%99%90"><span class="nav-text">认证与权限</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AE%A4%E8%AF%81%E4%B8%8E%E6%9D%83%E9%99%90%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="nav-text">认证与权限的区别</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%99%E8%A7%86%E5%9B%BE%E6%B7%BB%E5%8A%A0%E6%9D%83%E9%99%90"><span class="nav-text">给视图添加权限</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#DRF%E8%87%AA%E5%B8%A6%E6%9D%83%E9%99%90%E7%B1%BB"><span class="nav-text">DRF自带权限类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E6%9D%83%E9%99%90"><span class="nav-text">自定义权限</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9B%B4%E5%A4%9A%E8%AE%BE%E7%BD%AE%E6%9D%83%E9%99%90%E6%96%B9%E5%BC%8F"><span class="nav-text">更多设置权限方式</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AE%A4%E8%AF%81%E8%AF%A6%E8%A7%A3%E4%B8%8Etoken%E8%AE%A4%E8%AF%81"><span class="nav-text">认证详解与token认证</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AE%A4%E8%AF%81"><span class="nav-text">认证</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#DRF%E8%87%AA%E5%B8%A6%E8%AE%A4%E8%AF%81%E6%96%B9%E6%A1%88"><span class="nav-text">DRF自带认证方案</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#DRF%E4%B8%AD%E8%AE%BE%E7%BD%AE%E8%AE%A4%E8%AF%81%E6%96%B9%E6%A1%88"><span class="nav-text">DRF中设置认证方案</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E8%AE%A4%E8%AF%81%E6%96%B9%E6%A1%88"><span class="nav-text">自定义认证方案</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB%E6%97%B6%E4%B8%BA%E4%BD%95%E6%8E%A8%E8%8D%90token%E8%AE%A4%E8%AF%81"><span class="nav-text">前后端分离时为何推荐token认证</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#TokenAuthentication"><span class="nav-text">TokenAuthentication</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#JWT%E8%AE%A4%E8%AF%81"><span class="nav-text">JWT认证</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Json-Web-Token%E4%BB%8B%E7%BB%8D"><span class="nav-text">Json Web Token介绍</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#DRF%E4%B8%AD%E4%BD%BF%E7%94%A8JWT%E8%AE%A4%E8%AF%81"><span class="nav-text">DRF中使用JWT认证</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Simple-JWT%E7%9A%84%E9%BB%98%E8%AE%A4%E8%AE%BE%E7%BD%AE"><span class="nav-text">Simple JWT的默认设置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E4%BB%A4%E7%89%8C"><span class="nav-text">自定义令牌</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E8%AE%A4%E8%AF%81%E5%90%8E%E5%8F%B0"><span class="nav-text">自定义认证后台</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%86%E9%A1%B5"><span class="nav-text">分页</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#DRF%E6%8F%90%E4%BE%9B%E7%9A%84%E5%88%86%E9%A1%B5%E7%B1%BB"><span class="nav-text">DRF提供的分页类</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%87%E6%BB%A4%E4%B8%8E%E6%8E%92%E5%BA%8F"><span class="nav-text">过滤与排序</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%87%8D%E5%86%99get-queryset%E6%96%B9%E6%B3%95"><span class="nav-text">重写get_queryset方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8django-filter"><span class="nav-text">使用django-filter</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%B9%E6%B3%95%E4%B8%89-%E4%BD%BF%E7%94%A8SearchFilter%E7%B1%BB"><span class="nav-text">方法三: 使用SearchFilter类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8E%92%E5%BA%8FOrderingFilter%E7%B1%BB"><span class="nav-text">排序OrderingFilter类</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%99%90%E6%B5%81"><span class="nav-text">限流</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%99%90%E6%B5%81%E6%A6%82%E5%BF%B5"><span class="nav-text">限流概念</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%A8%E5%B1%80%E4%BD%BF%E7%94%A8%E9%99%90%E6%B5%81%E7%B1%BB"><span class="nav-text">全局使用限流类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%86%E5%9B%BE%E7%B1%BB%E6%88%96%E8%A7%86%E5%9B%BE%E9%9B%86%E4%B8%AD%E4%BD%BF%E7%94%A8%E9%99%90%E6%B5%81%E7%B1%BB"><span class="nav-text">视图类或视图集中使用限流类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ScopeRateThrottle%E7%B1%BB"><span class="nav-text">ScopeRateThrottle类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E9%99%90%E6%B5%81%E7%B1%BB"><span class="nav-text">自定义限流类</span></a></li></ol></li></ol>

    </div>
</div>
        </div>
    
</div>



                

            </div>

            

        </div>

        <div class="main-content-footer">
            <footer class="footer mt-5 py-5 h-auto text-base text-third-text-color relative border-t-2 border-t-border-color">
    <div class="info-container py-3 text-center">
        
        <div class="text-center">
            &copy;
            
              <span>2024</span>
              -
            
            2024&nbsp;&nbsp;<i class="fa-solid fa-heart fa-beat" style="--fa-animation-duration: 0.5s; color: #f54545"></i>&nbsp;&nbsp;<a href="/">rainbowYao</a>
            
                
                <p class="post-count space-x-0.5">
                    <span>
                        共 14 篇文章
                    </span>
                    
                </p>
            
        </div>
        
            <script data-swup-reload-script src="https://cn.vercount.one/js"></script>
            <div class="relative text-center lg:absolute lg:right-[20px] lg:top-1/2 lg:-translate-y-1/2 lg:text-right">
                
                    <span id="busuanzi_container_site_uv" class="lg:!block">
                        <span class="text-sm">访问人数</span>
                        <span id="busuanzi_value_site_uv"></span>
                    </span>
                
                
                    <span id="busuanzi_container_site_pv" class="lg:!block">
                        <span class="text-sm">总访问量</span>
                        <span id="busuanzi_value_site_pv"></span>
                    </span>
                
            </div>
        
        <div class="relative text-center lg:absolute lg:left-[20px] lg:top-1/2 lg:-translate-y-1/2 lg:text-left">
            <span class="lg:block text-sm">由 <?xml version="1.0" encoding="utf-8"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg class="relative top-[2px] inline-block align-baseline" version="1.1" id="圖層_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="1rem" height="1rem" viewBox="0 0 512 512" enable-background="new 0 0 512 512" xml:space="preserve"><path fill="#0E83CD" d="M256.4,25.8l-200,115.5L56,371.5l199.6,114.7l200-115.5l0.4-230.2L256.4,25.8z M349,354.6l-18.4,10.7l-18.6-11V275H200v79.6l-18.4,10.7l-18.6-11v-197l18.5-10.6l18.5,10.8V237h112v-79.6l18.5-10.6l18.5,10.8V354.6z"/></svg><a target="_blank" class="text-base" href="https://hexo.io">Hexo</a> 驱动</span>
            <span class="text-sm lg:block">主题&nbsp;<a class="text-base" target="_blank" href="https://github.com/EvanNotFound/hexo-theme-redefine">Redefine v2.6.4</a></span>
        </div>
        
        
            <div>
                博客已运行 <span class="odometer" id="runtime_days" ></span> 天 <span class="odometer" id="runtime_hours"></span> 小时 <span class="odometer" id="runtime_minutes"></span> 分钟 <span class="odometer" id="runtime_seconds"></span> 秒
            </div>
        
        
            <script data-swup-reload-script>
                try {
                    function odometer_init() {
                    const elements = document.querySelectorAll('.odometer');
                    elements.forEach(el => {
                        new Odometer({
                            el,
                            format: '( ddd).dd',
                            duration: 200
                        });
                    });
                    }
                    odometer_init();
                } catch (error) {}
            </script>
        
        
        
    </div>  
</footer>
        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="article-tools-list">
        <!-- TOC aside toggle -->
        
            <li class="right-bottom-tools page-aside-toggle">
                <i class="fa-regular fa-outdent"></i>
            </li>
        

        <!-- go comment -->
        
    </ul>
</div>

        </div>
    

    <div class="right-side-tools-container">
        <div class="side-tools-container">
    <ul class="hidden-tools-list">
        <li class="right-bottom-tools tool-font-adjust-plus flex justify-center items-center">
            <i class="fa-regular fa-magnifying-glass-plus"></i>
        </li>

        <li class="right-bottom-tools tool-font-adjust-minus flex justify-center items-center">
            <i class="fa-regular fa-magnifying-glass-minus"></i>
        </li>

        <li class="right-bottom-tools tool-dark-light-toggle flex justify-center items-center">
            <i class="fa-regular fa-moon"></i>
        </li>

        <!-- rss -->
        

        

        <li class="right-bottom-tools tool-scroll-to-bottom flex justify-center items-center">
            <i class="fa-regular fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="visible-tools-list">
        <li class="right-bottom-tools toggle-tools-list flex justify-center items-center">
            <i class="fa-regular fa-cog fa-spin"></i>
        </li>
        
            <li class="right-bottom-tools tool-scroll-to-top flex justify-center items-center">
                <i class="arrow-up fas fa-arrow-up"></i>
                <span class="percent"></span>
            </li>
        
        
    </ul>
</div>

    </div>

    <div class="image-viewer-container">
    <img src="">
</div>


    

</main>


    
<script src="/js/libs/Swup.min.js"></script>

<script src="/js/libs/SwupSlideTheme.min.js"></script>

<script src="/js/libs/SwupScriptsPlugin.min.js"></script>

<script src="/js/libs/SwupProgressPlugin.min.js"></script>

<script src="/js/libs/SwupScrollPlugin.min.js"></script>

<script src="/js/libs/SwupPreloadPlugin.min.js"></script>

<script>
    const swup = new Swup({
        plugins: [
            new SwupScriptsPlugin({
                optin: true,
            }),
            new SwupProgressPlugin(),
            new SwupScrollPlugin({
                offset: 80,
            }),
            new SwupSlideTheme({
                mainElement: ".main-content-body",
            }),
            new SwupPreloadPlugin(),
        ],
        containers: ["#swup"],
    });
</script>







<script src="/js/tools/imageViewer.js" type="module"></script>

<script src="/js/utils.js" type="module"></script>

<script src="/js/main.js" type="module"></script>

<script src="/js/layouts/navbarShrink.js" type="module"></script>

<script src="/js/tools/scrollTopBottom.js" type="module"></script>

<script src="/js/tools/lightDarkSwitch.js" type="module"></script>

<script src="/js/layouts/categoryList.js" type="module"></script>





    
<script src="/js/tools/codeBlock.js" type="module"></script>




    
<script src="/js/layouts/lazyload.js" type="module"></script>




    
<script src="/js/tools/runtime.js"></script>

    
<script src="/js/libs/odometer.min.js"></script>

    
<link rel="stylesheet" href="/assets/odometer-theme-minimal.css">




  
<script src="/js/libs/Typed.min.js"></script>

  
<script src="/js/plugins/typed.js" type="module"></script>









<div class="post-scripts" data-swup-reload-script>
    
        
<script src="/js/tools/tocToggle.js" type="module"></script>

<script src="/js/layouts/toc.js" type="module"></script>

<script src="/js/plugins/tabs.js" type="module"></script>

    
</div>


</body>
</html>
